# å…‹éš†è‡ªèšå®½æ–‡ç« ï¼šhttps://www.joinquant.com/post/65761
# æ ‡é¢˜ï¼š[å·²å®ç›˜]ä¸‰é©¬v10.3- å¹´åŒ–151% å›æ’¤11%
# ä½œè€…ï¼šå¸ƒå®½é‡åŒ–

# å…‹éš†è‡ªèšå®½æ–‡ç« ï¼šhttps://www.joinquant.com/post/65582
# æ ‡é¢˜ï¼šã€è®¨è®ºå¸–ã€‘ä¸‰é©¾é©¬è½¦ç­–ç•¥-ä»Šå¹´æ¶¨177%å›æ’¤13%äº”å¹´21å€
# ä½œè€…ï¼šçƒŸèŠ±ä¸‰æœˆETF

# å…‹éš†è‡ªèšå®½æ–‡ç« ï¼šhttps://www.joinquant.com/post/63661
# æ ‡é¢˜ï¼šä¸‰é©¬v10.2 æµ‹è¯•æ¡†æ¶
# ä½œè€…ï¼šCibo

"""
Cibo ä¸‰é©¾é©¬è½¦ä¼˜åŒ–ç‰ˆ
ç­–ç•¥1ï¼šå°å¸‚å€¼ç­–ç•¥
ç­–ç•¥2ï¼šETFåå¼¹ç­–ç•¥ (åªèƒ½æµ‹è¯• 23.9æœˆå, 2000etfä¸Šå¸‚æ—¶é—´ä¸º23.9)
ç­–ç•¥3ï¼šETFè½®åŠ¨ç­–ç•¥
ç­–ç•¥4ï¼šç™½é©¬æ”»é˜² v2.0

å†™åœ¨æœ€å‰é¢
å®ç›˜ç›¸å…³çš„æŒ‡å¼•:
https://www.joinquant.com/view/community/detail/4c8dda11f3ebda5ce562c2d3375a1740?type=1
ç›¸å…³çš„ç­–ç•¥è®°å½•æŒ‡å¼•æ–¹ä¾¿å›æº¯
ç­–ç•¥1 ç‰¹ä¹ˆæ‰¾ä¸åˆ°äº†
ç­–ç•¥2 https://www.joinquant.com/post/61536
ç­–ç•¥3 https://www.joinquant.com/post/62083
ç­–ç•¥4 https://www.joinquant.com/post/61890

è¿­ä»£è®°å½•
v1.0 åŸå§‹ç­–ç•¥
v2.0 æ”¹è¿›     ç­–ç•¥1 å°å¸‚å€¼æ–°å¢è¡Œä¸šåˆ†æ•£, ä¼˜åŒ–ç­–ç•¥2 åŸºç¡€ç™½é©¬ä¸ºå¸‚åœºæ¸©åº¦æ”»é˜²ç™½é©¬, ä¼˜åŒ–ç­–ç•¥3 ETFåŠ¨é‡è½®åŠ¨æ–°å¢é™å¹… 5% ä¸‰æ—¥æ£€æµ‹
v2.1    æ–°å¢  æ¢æ‰‹æ”¾é‡æ£€æµ‹, ä¼˜åŒ–æ¯æ—¥æŒä»“æ‰“å°, ä¼˜åŒ–å–å‡ºåçš„ç›ˆäºæ‰“å°, æ–°å¢å­ç­–ç•¥æ”¶ç›Šç‹¬ç«‹å±•ç¤º
v2.2    æ–°å¢   MCAD å¤§ç›˜æ‹©æ—¶, æ–°å¢å®ç›˜å¯ç”¨é…ç½®
v3.0    ä¼˜åŒ–  ç­–ç•¥1 å°å¸‚å€¼ç­–ç•¥åŒå¸‚å€¼ç­›é€‰
v4.0 æ”¹è¿›     ç­–ç•¥2 ç™½é©¬, ä½¿ç”¨ä¸­è¯2000ETFä¸‹è·Œåå¼¹è¿›è¡Œæ›¿æ¢
v4.1    ä¿®å¤  æ­¢æŸæ— æ³•å–å‡ºçš„bug
v5.0 æ”¹è¿›     ç­–ç•¥1 å°å¸‚å€¼è°ƒæ•´ä¸ºç¾¤å‹è¿·å¦¹çš„ä¼˜åŒ–ç‰ˆæœ¬(ç±»å›½ä¹), äºv4.1ç›¸æ¯”, é•¿å‘¨æœŸæ”¶ç›Šä¸­å¹…é™ä½å›æ’¤å¤§å¹…é™ä½, çŸ­å‘¨æœŸæ”¶ç›Šå°å¹…é™ä½, å›æ’¤å°å¹…å¢å¤§
v5.1    æ–°å¢  æˆäº¤é¢å®½åº¦é˜²å¾¡æ£€æµ‹, å¯¹æ¯”v5.0é•¿å›æµ‹å‡å°‘æ”¶ç›Š(70->63)å’Œå›æ’¤(19->14), é™ä½é£é™©
v6.0 æ”¹è¿›     ç­–ç•¥2 ä¸­è¯2000ETFç­–ç•¥æ‹“å±•, æŒä»“æ—¶é—´è°ƒæ•´(2->5), å¢åŠ åå¤‡é€‰é¡¹åˆ°5ä¸ª
v6.1    ä¼˜åŒ–  æˆäº¤é¢æ£€æµ‹æ–°å¢ç¼“å­˜é¿å…å›æµ‹å¤ªä¹…é—®é¢˜, å†™æ­» 18.1.1-25.10.10è§¦å‘æ—¶é—´
v6.2    æ–°å¢  ç§»åŠ¨æ­¢æŸåŠŸèƒ½, ä»¥æŒä»“å‘¨æœŸä¸­æœ€é«˜ç‚¹æ”¶ç›Šä½œä¸ºæˆæœ¬ä»·, (ä¸é€‚ç”¨å°å¸‚å€¼, æ›´é€‚åˆå¤§æ³¢æ®µè¶‹åŠ¿)
v6.3    ä¼˜åŒ–  äº¤æ˜“æ—¶æ£€æŸ¥æ˜¯å¦åœç‰Œ, åœç‰Œåˆ™ä¸è¿›è¡Œäº¤æ˜“, ä¿æŒæ—¥å¿—æ¸…æ´
v6.4    ä¼˜åŒ–  åˆæ¬¡è¿è¡Œç«‹å³è¿è¡Œç›‘æµ‹æœºåˆ¶
v7.0    æµ‹è¯•  ç­–ç•¥1 å°å¸‚å€¼æ–°å¢è¥æ”¶å¢é•¿ç‡ + å®¡è®¡ç­›é€‰ (èˆå¼ƒ)
v8.0 æ”¹è¿›     æ–°å¢ç­–ç•¥4 ç™½é©¬æ”»é˜²v2.0
v8.1    ä¼˜åŒ–  åŠ¨é‡è®¡ç®—æ•´åˆ(ETFè½®åŠ¨/ç™½é©¬æ”»é˜²)
v9.0 æ”¹è¿›     ç­–ç•¥3 ETFè½®åŠ¨æ–°å¢RSRS+å‡ä»·æ£€æµ‹, æˆäº¤é‡æ£€æµ‹
v9.1    ä¿®å¤  æ£€æŸ¥æ¶¨åœæ‰“å¼€æ¸…é™¤æ—¶ç´¢å¼•å¼‚å¸¸é—®é¢˜å¤„ç†
v9.2    ä¿®å¤  ç­–ç•¥3 æŒä»“è®°å½•åˆ—è¡¨å­˜åœ¨é‡å¤æƒ…å†µ, æ£€æŸ¥æ˜¯è¿›è¡Œå»é‡å¤„ç†
v9.3    æ–°å¢  ç­–ç•¥3 æ—¥å†…æ­¢æŸç›¸å…³æ£€æµ‹
v9.4    ä¿®å¤  æ¸…ä»“æ—¶å˜æ›´å¾ªç¯ä½“bugï¼Œæµ…æ‹·è´è§£å†³
v9.5    ä¿®å¤  ç­–ç•¥4 ç™½é©¬v2èå…¥å¯æŒ‰æ¯”ä¾‹å›æµ‹å®ç›˜
v9.6    ä¼˜åŒ–  ç­–ç•¥3 å°¾ç›˜æ–°å¢ETFè½®åŠ¨æœ€æ–°æ’åæ‰“å°æ–¹ä¾¿æ˜æ—¥å‚è€ƒ
v9.7    ä¼˜åŒ–  é¦–æ¬¡è¿è¡Œé¡¶èƒŒç¦»æ£€æµ‹è¿‡å»10å¤©
v9.8    ä¼˜åŒ–  ä¼˜åŒ–æŒä»“è¡¨æ ¼æ‰“å°å±•ç¤ºæŒä»“æ¯”ä¾‹, æŒ‰ç­–ç•¥æ±‡æ€»
v9.9    ä¿®å¤  ç§»åŠ¨æ­¢æŸ bug å¤„ç†, æœªèƒ½åŠ¨æ€æ›´æ–°æœ€é«˜ä»·æ ¼
v9.10   ä¼˜åŒ–  ç­–ç•¥1,ç­–ç•¥3 ä¹°å–æ‹†åˆ†å¯ç‹¬ç«‹è®¾è®¡è¿è¡Œæ—¶é—´
v9.11   æ–°å¢  ç­–ç•¥2 åŸºäº2023.9.28 è¿›è¡Œèµ„é‡‘å†å¹³è¡¡ (2023.9.28ä¹‹å‰æ±‡å…¥ç­–ç•¥3, ä¹‹åè¿˜åŸ)
v9.12   æ–°å¢  ä¸­é‡‘è‚¡æŒ‡æœŸè´§æ‰“å° (å¼ƒç”¨, è½¬ç§»åˆ°ç ”ç©¶ç¯å¢ƒ)
v9.13   ä¼˜åŒ–  ç­–ç•¥3 è‚¡ç¥¨æ± æ›´æ–° (è‡ªä¸»æ›¿æ¢)
v10.0 æ”¹è¿›    ç­–ç•¥1 æ”¯æŒå¤šç‰ˆæœ¬å°å¸‚å€¼ç­–ç•¥é€‰æ‹©
v10.1   ä¼˜åŒ–  åŸºç¡€å·¥å…·ç›¸å…³æ›¿æ¢, ä¸å†å…·å¤‡ä»»ä½•å­ç­–ç•¥é€šç”¨å·¥å…·, é¿å…é¢‘ç¹æ”¹åŠ¨å½±å“å…¶ä»–ç­–ç•¥æ•ˆæœ
"""
import datetime
import math
import prettytable
import numpy as np
import pandas as pd
from datetime import timedelta
from jqdata import *
from jqfactor import *
from prettytable import PrettyTable

# from nredistrade import *  # å¯¼å…¥å®ç›˜ä¾èµ–

""" ====================== åŸºç¡€é…ç½® ====================== """


def initialize(context):
    set_backtest()  # è®¾ç½®å›æµ‹æ¡ä»¶
    set_params(context)  # è®¾ç½®åŸºç¡€å‚æ•°
    set_strategy_params(context)  # è®¾ç½®ç­–ç•¥å‚æ•°
    # setup_redis_trade(context, 'strategy1')  # è®¾ç½®å®ç›˜

    # è¿‡æ»¤æ—¥å¿—
    log.set_level('order', 'error')
    # log.set_level('system', 'error')
    # log.set_level('strategy', 'error')


# åŸºç¡€å‚æ•°è®¾ç½®
def set_params(context):
    # ç­–ç•¥å
    """
    æ³¨æ„:
    1. ç™½é©¬v2æ˜¯åŠæˆå“å¼€å‘å†…å®¹, æ”¾è¿›æ¥å¸Œæœ›å¤§å®¶å»ä¼˜åŒ–äº†. ç›®å‰æ”¶ç›Šä½å›æ’¤å¤§, ciboæœ¬äººæ˜¯ä¸ä¼šè€ƒè™‘å®ç›˜ä½¿ç”¨
    2. å¯¹äºç™½é©¬v2æ˜¯å¦ä½¿ç”¨ä¾æ—§ä¿æŒ ä¸‰é©¬v4.0 ç‰ˆæœ¬æ›¿æ¢æ‰çš„ç»“è®º
    3. ETFåå¼¹æ ¸å¿ƒæ ‡çš„åœ¨23.9æœˆæ‰ä¸Šå¸‚, å›æµ‹è¿‡å»å‘¨æœŸç­–ç•¥å¤±æ•ˆ
    4. æœ¬ç­–ç•¥é¢„è®¾çš„ç ”ç©¶å‘¨æœŸè®¾è®¡ä¸º é•¿:18-25, ä¸­20-25, çŸ­24-25, æ—©äº18çš„ 15/17 æç«¯è¡Œæƒ…æš‚ä¸åšè€ƒè™‘
    """
    # g.portfolio_value_proportion = [0.35, 0.1, 0.35, 0.2]  # å°å¸‚å€¼/ETFåå¼¹/ETFè½®åŠ¨/ç™½é©¬æ”»é˜² (å®ç›˜)
    # g.portfolio_value_proportion = [0.4, 0.2, 0.4, 0]  # å°å¸‚å€¼/ETFåå¼¹/ETFè½®åŠ¨ (å®ç›˜/çŸ­å›æµ‹)
    g.portfolio_value_proportion = [0.5, 0, 0.5, 0]  # å°å¸‚å€¼/ETFè½®åŠ¨ (ç”¨äºé•¿å›æµ‹)
    # g.portfolio_value_proportion = [0.35, 0, 0.35, 0.3]  # å°å¸‚å€¼/ETFè½®åŠ¨/ç™½é©¬ (ç”¨äºé•¿å›æµ‹)

    # g.portfolio_value_proportion = [1, 0, 0, 0]  # æµ‹è¯•å°å¸‚å€¼
    # g.portfolio_value_proportion = [0, 1, 0, 0]  # æµ‹è¯•ETFåå¼¹
    # g.portfolio_value_proportion = [0, 0, 1, 0]  # æµ‹è¯•ETFè½®åŠ¨
    # g.portfolio_value_proportion = [0, 0, 0, 1]  # æµ‹è¯•ç™½é©¬æ”»é˜²

    g.starting_cash = context.portfolio.total_value  # ç­–ç•¥åˆå§‹èµ„é‡‘, ç”¨äºè®¡ç®—å­ç­–ç•¥æ”¶ç›Šæ³¢åŠ¨æ›²çº¿
    g.stock_strategy = {}  # è®°å½•è‚¡ç¥¨å¯¹åº”çš„ç­–ç•¥, åå‘æ˜ å°„æ–¹ä¾¿æ£€ç´¢
    g.strategy_holdings = {1: [], 2: [], 3: [], 4: []}
    # è®°å½•ç­–ç•¥åˆå§‹çš„é‡‘é¢, ç”¨äºè®¡ç®—å„ç­–ç•¥æ”¶ç›Šæ³¢åŠ¨æ›²çº¿
    g.strategy_starting_cash = {
        1: g.starting_cash * g.portfolio_value_proportion[0],  # å°å¸‚å€¼ åˆå§‹èµ„é‡‘
        2: g.starting_cash * g.portfolio_value_proportion[1],  # ETFåå¼¹ åˆå§‹èµ„é‡‘
        3: g.starting_cash * g.portfolio_value_proportion[2],  # ETFè½®åŠ¨ åˆå§‹èµ„é‡‘
        4: g.starting_cash * g.portfolio_value_proportion[3],  # ç™½é©¬æ”»é˜² åˆå§‹èµ„é‡‘
    }
    # è®°å½•æ¯æ—¥ç­–ç•¥æ”¶ç›Š
    g.strategy_value_data = {}
    g.strategy_value = {
        1: g.starting_cash * g.portfolio_value_proportion[0],  # å°å¸‚å€¼ åˆå§‹èµ„é‡‘
        2: g.starting_cash * g.portfolio_value_proportion[1],  # ETFåå¼¹ åˆå§‹èµ„é‡‘
        3: g.starting_cash * g.portfolio_value_proportion[2],  # ETFè½®åŠ¨ åˆå§‹èµ„é‡‘
        4: g.starting_cash * g.portfolio_value_proportion[3],  # ç™½é©¬æ”»é˜² åˆå§‹èµ„é‡‘
    }
    # æš‚å­˜ä¸€ä¸ªETFåå¼¹çš„åˆå§‹æ¯”ä¾‹
    g.strategy_ETF_2000_proportion = g.portfolio_value_proportion[1]
    g.strategy_ETF_2000_proportion_reset = None  # ç”¨äºæ£€æµ‹æ‹¨æ­£
    capital_balance_2(context)  # é¦–æ¬¡å°±è¿›è¡Œä¸€æ¬¡æ£€æµ‹


# ç­–ç•¥å‚æ•°è®¾ç½®
def set_strategy_params(context):
    """ ç­–ç•¥1 å°å¸‚å€¼ å‚æ•° """
    g.huanshou_check = False  # æ”¾é‡æ¢æ‰‹æ£€æµ‹ï¼ŒTureæ˜¯æ—¥é¢‘åˆ¤æ–­æ˜¯å¦æ”¾é‡ï¼ŒFalseåˆ™ä¸ç„¶
    g.xsz_version = "v3"  # å¸‚å€¼é€‰ç”¨ç‰ˆæœ¬ å¯é€‰å€¼: v1/v2/v3 å…·ä½“é€»è¾‘è‡ªå·±çœ‹ä»£ç å§, å†™ä¸ä¸‹
    g.enable_dynamic_stock_num = True  # å¯ç”¨åŠ¨æ€é€‰è‚¡æ•°é‡ 3~6
    g.xsz_stock_num = 5  # é»˜è®¤çš„æŒè‚¡æ•°é‡, å¯ç”¨åŠ¨æ€åä¼šè¢«è¦†ç›–ä¸º 3~6
    g.yesterday_HL_list = []  # æ˜¨æ—¥æ¶¨åœè‚¡ç¥¨
    g.target_list = []  # ç›®æ ‡æŒä»“è‚¡ç¥¨
    g.xsz_buy_etf = "512800.XSHG"  # ç©ºä»“æ—¶è´­ä¹°ETF
    # æ­¢æŸæ£€æŸ¥
    g.run_stoploss = True  # æ˜¯å¦è¿›è¡Œæ­¢æŸ
    g.stoploss_strategy = 3  # 1ä¸ºæ­¢æŸçº¿æ­¢æŸï¼Œ2ä¸ºå¸‚åœºè¶‹åŠ¿æ­¢æŸ, 3ä¸ºè”åˆ1ã€2ç­–ç•¥
    g.stoploss_limit = 0.09  # æ­¢æŸçº¿
    g.stoploss_market = 0.05  # å¸‚åœºè¶‹åŠ¿æ­¢æŸå‚æ•°
    # é¡¶èƒŒç¦»æ£€æŸ¥
    g.DBL_control = True  # å°å¸‚å€¼å¤§ç›˜é¡¶èƒŒç¦»è®°å½•ï¼ˆç”¨äºé£é™©æ§åˆ¶ï¼‰
    g.dbl = []
    g.check_dbl_days = 10  # é¡¶èƒŒç¦»æ£€æµ‹çª—å£æœŸé•¿åº¦, çª—å£å†…ä¸ä»…ä¹°å…¥
    # å¼‚å¸¸å¤„ç†çª—å£æœŸæ£€æŸ¥
    g.check_after_no_buy = False  # æ£€æŸ¥åä¸å†ä¹°å…¥æ—¶é—´
    g.no_buy_stocks = {}  # æ£€æŸ¥å–å‡ºçš„è‚¡ç¥¨
    g.no_buy_after_day = 3  # æ­¢æŸåä¸ä¹°å…¥çš„æ—¶é—´çª—å£
    # æˆäº¤é¢å®½åº¦æ£€æŸ¥
    g.check_defense = False  # æˆäº¤é¢å®½åº¦æ£€æŸ¥
    g.industries = ["ç»„20"]  # é«˜ä½é˜²å¾¡æ¿å—
    g.defense_signal = None
    g.cnt_defense_signal = []  # æ‹©æ—¶æ¬¡æ•°
    g.cnt_bank_signal = []  # ç»„20æ‹©æ—¶æ¬¡æ•°
    g.history_defense_date_list = []

    """ ç­–ç•¥2 ETFåå¼¹ å‚æ•° """
    g.limit_days = 2  # æœ€å°‘æŒä»“å‘¨æœŸ
    g.n_days = 5  # æŒä»“å‘¨æœŸ
    g.holding_days = 0
    g.buy_list = []
    # etfæ± å­ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½
    g.etf_pool_2 = [
        '159536.XSHE',  # ä¸­è¯2000
        '159629.XSHE',  # ä¸­è¯1000
        '159922.XSHE',  # ä¸­è¯500
        '159919.XSHE',  # æ²ªæ·±300
        '159783.XSHE'  # åŒåˆ›50
    ]

    """ ç­–ç•¥3 ETFè½®åŠ¨ å‚æ•° """
    # ç­–ç•¥3å…¨å±€å˜é‡
    g.etf_pool_3 = [
        # å¤šæ ·æ€§å¸‚åœº
        "510180.XSHG",  # ä¸Šè¯180ETFï½œæˆç«‹ï¼š2006-04-13ï¼ˆåå®‰ï¼‰
        "513030.XSHG",  # å¾·å›½DAX ETFï½œæˆç«‹ï¼š2014-08-08ï¼ˆåå®‰ï¼‰
        "513100.XSHG",  # çº³æŒ‡ETFï½œæˆç«‹ï¼š2013-04-25ï¼ˆå›½æ³°ï¼‰
        "513520.XSHG",  # æ—¥ç»225ETFï½œæˆç«‹ï¼š2019-06-12ï¼ˆåå¤ï¼‰

        # å¤§å®—å•†å“
        "510410.XSHG",  # ä¸Šè¯è‡ªç„¶èµ„æºETFï½œæˆç«‹ï¼š2012-04-10ï¼ˆåšæ—¶ï¼‰
        "518880.XSHG",  # é»„é‡‘ETFï½œæˆç«‹ï¼š2013-07-18ï¼ˆåå®‰ï¼‰
        "501018.XSHG",  # å—æ–¹åŸæ²¹ï¼ˆLOFï¼‰ï½œæˆç«‹ï¼š2016-06-15ï¼ˆå—æ–¹ï¼‰
        "159985.XSHE",  # è±†ç²•æœŸè´§ETFï½œæˆç«‹ï¼š2019-09-24ï¼ˆåå¤ï¼‰
        "511090.XSHG",  # 30å¹´æœŸå›½å€ºETFï½œæˆç«‹ï¼š2023-05-19ï¼ˆé¹æ‰¬ï¼‰

        # ç§‘æŠ€æˆé•¿
        "159915.XSHE",  # åˆ›ä¸šæ¿ETFï½œæˆç«‹ï¼š2011-09-20ï¼ˆæ˜“æ–¹è¾¾ï¼‰
        "588120.XSHG",  # ç§‘åˆ›100ETFï½œæˆç«‹ï¼š2023-09-06ï¼ˆå›½æ³°ï¼‰
        "512480.XSHG",  # åŠå¯¼ä½“ETFï½œæˆç«‹ï¼š2019-05-08ï¼ˆå›½è”å®‰ï¼‰
        "159851.XSHE",  # é‡‘èç§‘æŠ€ETFï½œæˆç«‹ï¼š2021-03-04ï¼ˆåå®ï¼‰
        '513020.XSHG',  # æ¸¯è‚¡ç§‘æŠ€ETF | æˆç«‹ 2022-01-19 ï¼ˆå›½æ³°ï¼‰
        "159637.XSHE",  # æ–°èƒ½æºè½¦é¾™å¤´ETFï½œæˆç«‹ï¼š2022-08-19ï¼ˆä¸œè´¢ï¼‰

        # è“ç­¹é«˜è‚¡æ¯
        "513690.XSHG",  # æ¸¯è‚¡çº¢åˆ©/æ’ç”Ÿé«˜è‚¡æ¯ETFï½œæˆç«‹ï¼š2021-05-11ï¼ˆåšæ—¶ï¼‰
        "510050.XSHG",  # ä¸Šè¯180ETF

        # "159980.XSHE",  # æœ‰è‰²æœŸè´§ETFï½œæˆç«‹ï¼š2019-10-24ï¼ˆå¤§æˆï¼‰  # é‡å¤äº†
        # "516160.XSHG",  # æ–°èƒ½æºETFï½œæˆç«‹ï¼š2021-01-22ï¼ˆå—æ–¹ï¼‰ # é‡å¤äº†
        # "513130.XSHG",  # æ’ç”Ÿç§‘æŠ€ETFï½œæˆç«‹ï¼š2021-05-24ï¼ˆåæ³°æŸç‘ï¼‰ # é‡å¤äº†

        # "512710.XSHG",  # å†›å·¥é¾™å¤´ETFï½œæˆç«‹ï¼š2019-07-23ï¼ˆå¯Œå›½ï¼‰  # å¤ªçŒ›
        # "159692.XSHE",  # è¯åˆ¸ETFï¼ˆä¸œè´¢ï¼‰ï½œæˆç«‹ï¼š2023-05-05  # å¤ªçŒ›
        # "515070.XSHG",  # äººå·¥æ™ºèƒ½ETFï½œæˆç«‹ï¼š2019-12-09ï¼ˆåå¤ï¼‰  # å¤ªçŒ›

        # "515650.XSHG",  # æ¶ˆè´¹50ETFï½œæˆç«‹ï¼š2019-10-14ï¼ˆå¯Œå›½ï¼‰ # å¤ªå¼±
        # "159550.XSHE",  # äº’è”ç½‘ETFï¼ˆæ²ªæ¸¯æ·±ï¼‰ï½œæˆç«‹ï¼š2025-06-18ï¼ˆä¸œè´¢ï¼‰ # å¤ªå¼±
        # "512290.XSHG",  # ç”Ÿç‰©åŒ»è¯ETFï½œæˆç«‹ï¼š2019-04-18ï¼ˆå›½æ³°ï¼‰ # å¤ªå¼±
    ]
    g.select_etf = None  # ETFäº¤æ˜“ä¼ é€’å˜é‡
    g.m_days = 25  # åŠ¨é‡å‚è€ƒå¤©æ•°
    g.m_score = 5  # åŠ¨é‡è¿‡æ»¤åˆ†æ•°
    g.enable_stop_loss_by_cur_day = True  # æ˜¯å¦å¼€å¯æ—¥å†…æ­¢æŸ
    g.stoploss_limit_by_cur_day = -0.3  # å½“æ—¥äºæŸ -3%

    """ ç­–ç•¥4 ç™½é©¬æ”»é˜² å‚æ•° """
    g.check_out_lists = []
    g.market_temperature = "warm"
    g.stock_num_2 = 5  # ç›®æ ‡æŒè‚¡æ•°é‡
    g.roe = 10  # ROEæƒé‡
    g.roa = 6  # ROAæƒé‡


# å›æµ‹è®¾ç½®
def set_backtest():
    set_option('avoid_future_data', True)
    set_benchmark('000300.XSHG')
    set_option('use_real_price', True)

    set_slippage(FixedSlippage(0.002), type="stock")
    set_slippage(FixedSlippage(0.001), type="fund")
    cost_configs = [
        ("stock", 0.0005, 0.85 / 10000, 5),
        ("fund", 0, 0.5 / 10000, 5),
        ("mmf", 0, 0, 0)
    ]
    for asset_type, close_tax, commission, min_comm in cost_configs:
        set_order_cost(OrderCost(
            open_tax=0, close_tax=close_tax,
            open_commission=commission, close_commission=commission,
            close_today_commission=0, min_commission=min_comm
        ), type=asset_type)


""" ====================== ç­–ç•¥1: å°å¸‚å€¼ ====================== """


# v1 é€‰è‚¡æ¨¡å— (åŒå¸‚å€¼+è¡Œä¸šåˆ†æ•£)
def xsz_get_stock_list_v1(context):
    # è·å–è‚¡ç¥¨æ‰€å±è¡Œä¸š
    def filter_industry_stock(stock_list):
        result = get_industry(security=stock_list)
        selected_stocks = []
        industry_list = []
        for stock_code, info in result.items():
            industry_name = info['sw_l2']['industry_name']
            if industry_name not in industry_list:
                industry_list.append(industry_name)
                selected_stocks.append(stock_code)
                print(f"è¡Œä¸šä¿¡æ¯: {industry_name} (è‚¡ç¥¨: {stock_code} {get_security_info(stock_code).display_name})")
                # é€‰å–äº† 10 ä¸ªä¸åŒè¡Œä¸šçš„è‚¡ç¥¨
                if len(industry_list) == 10:
                    break
        return selected_stocks

    initial_list = filter_stocks(context, get_index_stocks('399101.XSHE'))

    # è·å–æµé€šå¸‚å€¼æœ€å°çš„50ä¸ªè‚¡ç¥¨
    q = query(valuation.code).filter(valuation.code.in_(initial_list)).order_by(
        valuation.circulating_market_cap.asc()).limit(50)
    initial_list = list(get_fundamentals(q).code)
    # é€‰å–æ¯è‚¡æ”¶ç›Š>0çš„è‚¡ç¥¨
    # q = query(valuation.code, indicator.eps) \
    #     .filter(valuation.code.in_(initial_list)) \
    #     .filter(indicator.eps > 0) \
    #     .filter(valuation.market_cap > g.min_mv) \
    #     .filter(valuation.market_cap < g.max_mv) \
    #     .order_by(valuation.market_cap.asc())

    q = query(valuation.code).filter(valuation.code.in_(initial_list)).order_by(valuation.market_cap.asc())
    initial_list = list(get_fundamentals(q).code)
    initial_list = initial_list[:30]
    # æ¯ä¸ªè¡Œä¸šè·å–1ä¸ªè‚¡ç¥¨ï¼Œæ€»å…±è·å–g.stock_numä¸ªè¡Œä¸šçš„è‚¡ç¥¨
    final_list = filter_industry_stock(initial_list)[:g.xsz_stock_num]
    print('é€‰å‡ºçš„è‚¡ç¥¨:%s' % [f"{i} {get_security_info(i).display_name}" for i in final_list])
    return final_list


# v2 é€‰è‚¡æ¨¡å— (å›½ä¹+roa+roe)
def xsz_get_stock_list_v2(context):
    initial_list = filter_stocks(context, get_index_stocks('399101.XSHE'))

    # ä¿®å¤ï¼šæ­£ç¡®ä½¿ç”¨èšå®½åŸºæœ¬é¢è¡¨æŸ¥è¯¢æ–¹å¼
    q = query(
        valuation.code,
        valuation.market_cap,
        income.np_parent_company_owners,
        income.net_profit,
        income.operating_revenue,
        valuation.turnover_ratio
    ).filter(
        valuation.code.in_(initial_list),
        valuation.market_cap.between(5, 50),
        income.np_parent_company_owners > 0,
        income.net_profit > 0,
        income.operating_revenue > 1e8,
        fundamentals.indicator.roe > 0.15,
        fundamentals.indicator.roa > 0.10,
    ).order_by(valuation.market_cap.asc()).limit(50)
    df = get_fundamentals(q)
    if df.empty:
        return []
    final_list = list(df.code)
    last_prices = history(1, '1d', 'close', final_list, df=False)
    # ä»·æ ¼è¿‡æ»¤
    return [stock for stock in final_list if stock in context.portfolio.positions or last_prices[stock] <= 20][
           :g.xsz_stock_num]


# v3 é€‰è‚¡æ¨¡å— (å›½ä¹+çº¢åˆ©+å®¡è®¡)
def xsz_get_stock_list_v3(context):
    initial_list = filter_stocks(context, get_index_stocks('399101.XSHE'))

    q = query(
        valuation.code,
        valuation.market_cap,  # æ€»å¸‚å€¼ circulating_market_cap/market_cap
        # income.np_parent_company_owners,  # å½’å±äºæ¯å…¬å¸æ‰€æœ‰è€…çš„å‡€åˆ©æ¶¦
        income.net_profit,  # å‡€åˆ©æ¶¦
        income.operating_revenue  # è¥ä¸šæ”¶å…¥
        # security_indicator.net_assets
    ).filter(
        valuation.code.in_(initial_list),
        valuation.market_cap.between(10, 100),
        # income.np_parent_company_owners > g.np_parent_company_owners_min,
        income.operating_revenue > 1e8,
        indicator.roe > 0,
        indicator.roa > 0,
        income.net_profit > 2000000,  # å‡€åˆ©æ¶¦å¤§äº0
    ).order_by(valuation.market_cap.asc()).limit(g.xsz_stock_num * 5)
    final_list = list(get_fundamentals(q).code)
    # è¿‡æ»¤å®¡è®¡æ„è§
    final_list = filter_audit(context, final_list)
    # è¿‡æ»¤çº¢åˆ©è‚¡
    final_list = bonus_filter(context, final_list)
    # ç”±äºæœ‰æ—¶å€™é€‰è‚¡æ¡ä»¶è‹›åˆ»ï¼Œæ‰€ä»¥ä¼šæ²¡æœ‰è‚¡ç¥¨å…¥é€‰ï¼Œè¿™æ—¶ä¹°å…¥é“¶åæ—¥åˆ©ETF
    if not final_list:
        print('æ— é€‚åˆè‚¡ç¥¨ï¼Œä¹°å…¥ETF')
        return [g.xsz_buy_etf]
    # ä»·æ ¼è¿‡æ»¤
    last_prices = history(1, unit='1d', field='close', security_list=final_list)
    return [s for s in final_list if s in g.strategy_holdings[1] or last_prices[s][-1] <= 50]


# å°å¸‚å€¼æ—©ç›˜å˜é‡é¢„å¤„ç†
def prepare_xsz(context):
    g.trading_signal = False if context.current_dt.month in [1, 4] else True
    g.yesterday_HL_list = []
    # è·å–æ˜¨æ—¥æ¶¨åœåˆ—è¡¨
    if g.strategy_holdings[1]:
        df = get_price(g.strategy_holdings[1],
                       end_date=context.previous_date,
                       fields=['close', 'high_limit', 'low_limit'],
                       frequency='daily',
                       count=1,
                       panel=False,
                       fill_paused=False)
        g.yesterday_HL_list = list(df[df['close'] == df['high_limit']].code)


# å°å¸‚å€¼å–å‡º
def strategy_1_sell(context):
    print("-" * 45 + f"{str(context.current_dt.date())}" + "-" * 45)
    g.target_list = []
    # è¿‘æœŸæœ‰é¡¶èƒŒç¦»ä¿¡å·æ—¶æš‚åœè°ƒä»“ï¼ˆè§„é¿ç³»ç»Ÿæ€§é£é™©ï¼‰
    if g.DBL_control:
        # é¦–æ¬¡è¿è¡Œæ£€æµ‹æœ€è¿‘10æ—¥é¡¶èƒŒç¦»
        if len(g.dbl) < 10:
            for i in range(9, -1, -1):
                check_dbl(context, end_days=0 - i)
    if g.DBL_control and 1 in g.dbl[-g.check_dbl_days:]:
        print(f"è¿‘{g.check_dbl_days}æ—¥æ£€æµ‹åˆ°å¤§ç›˜é¡¶èƒŒç¦»ï¼Œæš‚åœè°ƒä»“ä»¥æ§åˆ¶é£é™©")
        return

    # æ£€æµ‹ç©ºä»“æœŸ
    month = context.current_dt.month
    if month in [1, 4]:
        g.trading_signal = False
    if not g.trading_signal:
        return

    # æˆäº¤é¢å®½åº¦æ£€æŸ¥
    if g.check_defense and g.defense_signal:
        print("è§¦å‘æˆäº¤é¢å®½åº¦æ£€æŸ¥ä¿¡å·ï¼Œæš‚åœè°ƒä»“ä»¥æ§åˆ¶é£é™©")
        return

    # åŠ¨æ€è°ƒæ•´é€‰è‚¡æ•°é‡
    diff = None
    if g.enable_dynamic_stock_num:
        ma_para = 10  # è®¾ç½®MAå‚æ•°
        today = context.previous_date
        start_date = today - timedelta(days=ma_para * 2)
        index_df = get_price('399101.XSHE', start_date=start_date, end_date=today, frequency='daily')
        index_df['ma'] = index_df['close'].rolling(window=ma_para).mean()
        last_row = index_df.iloc[-1]
        diff = last_row['close'] - last_row['ma']
        g.xsz_stock_num = 3 if diff >= 500 else \
            3 if 200 <= diff < 500 else \
                4 if -200 <= diff < 200 else \
                    5 if -500 <= diff < -200 else \
                        6
    # é€‰æ‹©è¦å¯ç”¨çš„é€‰è‚¡ç‰ˆæœ¬
    g.target_list = {
                        "v1": xsz_get_stock_list_v1,
                        "v2": xsz_get_stock_list_v2,
                        "v3": xsz_get_stock_list_v3,
                    }[g.xsz_version](context)[:g.xsz_stock_num]
    print(f'å°å¸‚å€¼ {g.xsz_version} ç›®æ ‡æŒè‚¡æ•°: {g.xsz_stock_num} [diff:{str(diff)[:6]}] ç›®æ ‡æŒä»“: {g.target_list}')

    # å–å‡ºä¸åœ¨ç›®æ ‡åˆ—è¡¨ä¸­çš„è‚¡ç¥¨ï¼ˆé™¤æ˜¨æ—¥æ¶¨åœè‚¡ï¼‰
    sell_list = [s for s in g.strategy_holdings[1] if s not in g.target_list and s not in g.yesterday_HL_list]
    hold_list = [s for s in g.strategy_holdings[1] if s in g.target_list or s in g.yesterday_HL_list]

    if sell_list:
        hold_list and print("å½“å‰æŒæœ‰ %s" % ([format_stock_code(stock) for stock in hold_list]))
        sell_list and print("è®¡åˆ’å–å‡º %s" % ([format_stock_code(stock) for stock in sell_list]))
    for stock in sell_list:
        close_position(stock)

    # current_data = get_current_data()
    # for stock in sell_list:
    #     current_stock_data = current_data[stock]
    #     if current_stock_data.paused:
    #         print(f"â­• {stock} åœç‰Œ, æ— æ³•å–å‡º")
    #     elif current_stock_data.last_price > current_stock_data.high_limit * 0.99:  # æ¶¨å¹…è¶…è¿‡ 9.9% æ¶¨åœæœªæ‰“å¼€
    #         print(f"â­• {stock} æ¶¨åœ, ä¸è¿›è¡Œå–å‡º")
    #     else:
    #         close_position(stock)


# å°å¸‚å€¼ä¹°å…¥
def strategy_1_buy(context):
    if not g.trading_signal:
        if g.xsz_buy_etf not in context.portfolio.positions:
            print("å°å¸‚å€¼æ¸…ä»“æ—¶æœŸ, ä¹°å…¥ETF")
            open_position(context, g.xsz_buy_etf, context.portfolio.total_value * g.portfolio_value_proportion[0], 1)
        return

    # è®¡ç®—å¯ç”¨èµ„é‡‘ï¼ˆç­–ç•¥1ä¸“ç”¨éƒ¨åˆ†ï¼‰
    strategy_value = context.portfolio.total_value * g.portfolio_value_proportion[0]
    current_value = sum(
        [pos.value for pos in context.portfolio.positions.values() if pos.security in g.strategy_holdings[1]])
    available_cash = max(0, strategy_value - current_value)  # ç¡®ä¿éè´Ÿ

    # ä¹°å…¥æ–°æ ‡çš„
    buy_list = [s for s in g.target_list if s not in g.strategy_holdings[1][:]]
    if buy_list and available_cash > 0:
        cash_per_stock = available_cash / len(buy_list)
        for stock in buy_list:
            open_position(context, stock, cash_per_stock, 1)


# æ¸…ä»“åæ¬¡æ—¥èµ„é‡‘å¯è½¬
def close_account(context):
    if not g.trading_signal:
        if g.strategy_holdings[1] and g.xsz_buy_etf not in g.strategy_holdings[1]:
            for stock in g.strategy_holdings[1][:]:
                print(f"ğŸ¤•ğŸ¤•ğŸ¤• è¿›å…¥æ¸…ä»“æœŸé—´ å–å‡º {format_stock_code(stock)}")
                close_position(stock)


# æ£€æŸ¥æ˜¨æ—¥æ¶¨åœè‚¡ä»Šæ—¥è¡¨ç°
def xsz_check_limit_up(context):
    # è·å–å½“å‰æŒä»“
    holdings = g.strategy_holdings[1][:]  # åªæ£€æŸ¥ç­–ç•¥1
    if holdings:
        now_time = context.current_dt
        if g.yesterday_HL_list:
            # å¯¹æ˜¨æ—¥æ¶¨åœè‚¡ç¥¨è§‚å¯Ÿåˆ°å°¾ç›˜å¦‚ä¸æ¶¨åœåˆ™æå‰å–å‡ºï¼Œå¦‚æœæ¶¨åœå³ä½¿ä¸åœ¨åº”ä¹°å…¥åˆ—è¡¨ä»æš‚æ—¶æŒæœ‰
            for stock in g.yesterday_HL_list:
                current_data = get_price(stock, end_date=now_time, frequency='1m', fields=['close', 'high_limit'],
                                         skip_paused=False, fq='pre', count=1, panel=False, fill_paused=True)
                if current_data.iloc[0, 0] < current_data.iloc[0, 1]:
                    print(f"ğŸ¥µğŸ¥µğŸ¥µ {format_stock_code(stock)} æ¶¨åœæ‰“å¼€ï¼Œå–å‡º")
                    close_position(stock)
                else:
                    print(f"ğŸ¤—ğŸ¤—ğŸ¤— {stock} ç»§ç»­æ¶¨åœï¼Œç»§ç»­æŒæœ‰")


# æ­¢ç›ˆæ­¢æŸ
def xsz_sell_stocks(context):
    if g.run_stoploss:
        current_positions = context.portfolio.positions
        if g.stoploss_strategy in [1, 3]:
            for stock in current_positions.keys():
                if stock in g.strategy_holdings[1]:
                    price = current_positions[stock].price
                    avg_cost = current_positions[stock].avg_cost
                    # ä¸ªè‚¡ç›ˆåˆ©æ­¢ç›ˆ
                    if price >= avg_cost * 2:
                        print(f"ğŸ¤‘ğŸ¤‘ğŸ¤‘ æ”¶ç›Š100%æ­¢ç›ˆ,å–å‡º {format_stock_code(stock)}")
                        close_position(stock)
                    # ä¸ªè‚¡æ­¢æŸ
                    elif price < avg_cost * (1 - g.stoploss_limit):
                        print(f"ğŸ¤¬ğŸ¤¬ğŸ¤¬ æ”¶ç›Šæ­¢æŸ,å–å‡º {format_stock_code(stock)}")
                        close_position(stock)
        if g.stoploss_strategy in [2, 3]:
            stock_df = get_price(security=get_index_stocks('399101.XSHE'),
                                 end_date=context.previous_date,
                                 frequency='daily',
                                 fields=['close', 'open'],
                                 count=1,
                                 panel=False)
            down_ratio = abs((stock_df['close'] / stock_df['open'] - 1).mean())
            # å¸‚åœºå¤§è·Œæ­¢æŸ
            if down_ratio >= g.stoploss_market:
                print(f"ğŸ¤¡ğŸ¤¡ğŸ¤¡ å¤§ç›˜æƒ¨è·Œ,å¹³å‡é™å¹… {down_ratio:.2%}")
                for stock in g.strategy_holdings[1][:]:
                    close_position(stock)


""" ====================== ç­–ç•¥2: ETFåå¼¹ ====================== """


# åŸå§‹ä¸­è¯2000ç­–ç•¥
def zz_2000_trade(context):
    to_buy = False
    etf_index = "159536.XSHE"
    # è·å–è¿‘3æ—¥çš„å†å²æ•°æ®
    df = get_price(etf_index, end_date=context.previous_date, count=3, frequency='daily', fields=['high'])
    df = df.reset_index()
    if len(df) < 3:
        return

    pre3_high_max = df['high'].max()

    # è·å–å½“å‰ç›˜ä¸­å®æ—¶æ•°æ®
    current_data = get_current_data()
    today_open = current_data[etf_index].day_open
    today_close = current_data[etf_index].last_price

    # ç­–ç•¥æ¡ä»¶åˆ¤æ–­ï¼Œå¼€ç›˜ç›¸æ¯”æœ€é«˜ä»·ä¸‹è·Œ2% & æœ€æ–°ä»·ç›¸æ¯”å¼€ç›˜ä»·æ¶¨1%
    if today_open / pre3_high_max < 0.98 and today_close / today_open > 1.01:
        to_buy = True

    # å·²ç»æŒä»“, æ£€æŸ¥æ˜¯å¦ç»§ç»­æŒæœ‰
    if etf_index in context.portfolio.positions:
        position = context.portfolio.positions[etf_index]
        trade_date = position.init_time
        holding_days = len(get_trade_days(start_date=trade_date, end_date=context.current_dt)) - 1
        # ä¸ç¬¦åˆå´æŒä»“è¶…è¿‡2å¤©, æ¸…ä»“
        if not to_buy and holding_days >= 2:
            close_position(etf_index)
            print(f"å–å‡ºï¼š{etf_index}, æŒä»“{holding_days}å¤©")
    # æœªæŒä»“, ä½†ç¬¦åˆæ¡ä»¶, è¿›è¡Œä¹°å…¥
    elif to_buy:
        strategy_value = context.portfolio.total_value * g.portfolio_value_proportion[1]
        open_position(context, etf_index, strategy_value, 2)
        print(f"ç¬¦åˆä¸­è¯2000ä¹°å…¥æ¡ä»¶ï¼š{etf_index}")


def strategy_2_sell(context):
    cur_date = str(context.current_dt.date())
    if cur_date <= "2023-10-01":
        return

    g.buy_list = []
    sell_list = []
    sell_for_money_list = []
    # è·å–è¿‘3æ—¥çš„å†å²æ•°æ®
    for etf in g.etf_pool_2:
        df = get_price(etf, end_date=context.previous_date, count=4, frequency='daily', fields=['high', 'close'])
        df = df.reset_index()
        if len(df) < 4:
            return
        pre_high_max = df['high'].max()
        yestoday_close = df['close'].iloc[-1]
        # è·å–å½“å‰ç›˜ä¸­å®æ—¶æ•°æ®
        current_data = get_current_data()
        today_open = current_data[etf].day_open
        today_close = current_data[etf].last_price
        # ä¹°å…¥æ¡ä»¶åˆ¤æ–­ï¼Œå¼€ç›˜ç›¸æ¯”æœ€é«˜ä»·ä¸‹è·Œ2% & æœ€æ–°ä»·ç›¸æ¯”å¼€ç›˜ä»·æ¶¨1%
        if today_open / pre_high_max < 0.98 and today_close / today_open > 1.01:
            g.buy_list.append(etf)
        # å–å‡ºæ¡ä»¶åˆ¤æ–­ï¼Œå½“å‰ä»·æ ¼å°äºæ˜¨æ—¥æ”¶ç›˜ä»·
        if today_close < yestoday_close:
            sell_list.append(etf)

    # ä¿ç•™æœ€ä½³æ ‡çš„
    if g.buy_list:
        g.buy_list.sort(key=lambda x: g.etf_pool_2.index(x))
        selected_etf = g.buy_list[0]
        g.buy_list = [selected_etf]
        current_holdings = g.strategy_holdings[2]
        if current_holdings and g.etf_pool_2.index(current_holdings[0]) < g.etf_pool_2.index(selected_etf):
            # å¦‚æœæœ‰æŒä»“ï¼Œä¸”æŒæœ‰çš„ETFä¸æ˜¯é«˜ä¼˜å…ˆçº§ETFï¼Œåˆ™æ¸…ä»“
            sell_for_money_list.append(current_holdings[0])

    for etf in g.strategy_holdings[2]:
        position = context.portfolio.positions[etf]
        security = position.security  # è‚¡ç¥¨ä»£ç 
        trade_date = position.init_time
        holding_days = len(get_trade_days(start_date=trade_date, end_date=context.current_dt)) - 1
        if (security in sell_list and holding_days >= g.limit_days) or (holding_days >= g.n_days) or \
                (security in sell_for_money_list):
            close_position(security)
            log.info(f"å–å‡ºï¼š{security}ï¼Œ æŒè‚¡{security} {holding_days}å¤©")
    if not g.buy_list:
        print(f"ç­–ç•¥2ä»Šæ—¥æ— åå¼¹å¯è´­ä¹°é€‰é¡¹")


def strategy_2_buy(context):
    cur_date = str(context.current_dt.date())
    if cur_date <= "2023-10-01":
        return

    g.buy_list = list(set(g.buy_list) - set(g.strategy_holdings[2]))
    if len(g.buy_list) > 0:
        cash = context.portfolio.total_value * g.portfolio_value_proportion[1]
        if cash < 100:
            log.warn(f'cashä¸è¶³:{context.portfolio.available_cash}')
        else:
            cash = context.portfolio.total_value * g.portfolio_value_proportion[1]
            for etf in g.buy_list:
                print(f"ç¬¦åˆç­–ç•¥2ä¹°å…¥æ¡ä»¶ï¼š{etf}")
                open_position(context, etf, cash, 2)


""" ====================== ç­–ç•¥3: ETFè½®åŠ¨ ====================== """


# åŠ¨é‡è®¡ç®—
def filter_moment_rank(stock_pool, days, ll, hh, show_print=True):
    print("è®¡ç®— åŠ¨é‡å¾—åˆ†" + "*" * 60)

    scores_data = pd.DataFrame(index=stock_pool, columns=["annualized_returns", "r2", "score"])
    current_data = get_current_data()
    print_info = {}

    for code in stock_pool:
        try:
            hist_data = attribute_history(code, days, "1d", ["close", "high"])
            if hist_data.empty:
                continue

            prices = np.append(hist_data["close"].values, current_data[code].last_price)
            log_prices = np.log(prices)
            x_values = np.arange(len(log_prices))
            weights = np.linspace(1, 2, len(log_prices))

            slope, intercept = np.polyfit(x_values, log_prices, 1, w=weights)
            annualized_return = math.exp(slope * 250) - 1
            scores_data.loc[code, "annualized_returns"] = annualized_return

            ss_res = np.sum(weights * (log_prices - (slope * x_values + intercept)) ** 2)
            ss_tot = np.sum(weights * (log_prices - np.mean(log_prices)) ** 2)
            r2 = 1 - ss_res / ss_tot if ss_tot > 0 else 0
            scores_data.loc[code, "r2"] = r2

            momentum_score = annualized_return * r2
            scores_data.loc[code, "score"] = momentum_score

            if min(prices[-1] / prices[-2], prices[-2] / prices[-3],
                   prices[-3] / prices[-4]) < 0.97:
                scores_data.loc[code, "score"] = 0
            print_info[code] = scores_data.loc[code, "score"]

        except Exception as e:
            print(f"è®¡ç®—{code}åŠ¨é‡å¾—åˆ†å¤±è´¥: {e}")
            scores_data.loc[code, "score"] = 0

    valid_etfs = scores_data[(scores_data['score'] > ll) & (scores_data['score'] < hh)] \
        .sort_values("score", ascending=False)
    rank_list = valid_etfs.index.tolist()
    if show_print and rank_list:
        for i in rank_list:
            print(f"{format_stock_code(i)} ({print_info[i]:.4f})")
    return rank_list


# æˆäº¤é‡è¿‡æ»¤
def filter_volume(context, stock_list, days=7, volume_threshold=2):
    """
    :param context:
    :param stock_list: è¦æ£€æµ‹çš„è‚¡ç¥¨
    :param days: æ£€æµ‹å‘¨æœŸå¤©æ•°
    :param volume_threshold: é˜ˆå€¼
    :return:
    """
    print("ETF å¼‚å¸¸æˆäº¤é‡æ£€æµ‹" + "*" * 60)

    def _get_volume_ratio(security):

        try:
            hist_data = attribute_history(security, days, '1d', ['volume'])
            if hist_data.empty or len(hist_data) < days:
                return
            avg_volume = hist_data['volume'].mean()
            df_vol = get_price(security, start_date=context.current_dt.date(), end_date=context.current_dt,
                               frequency='1m', fields=['volume'], skip_paused=False, fq='pre', panel=True,
                               fill_paused=False)
            if df_vol is None or df_vol.empty:
                return
            current_volume = df_vol['volume'].sum()
            _volume_ratio = current_volume / avg_volume
            # æ£€æµ‹åˆ°å¼‚å¸¸, è¿”å›å¼‚å¸¸å€æ•°
            if _volume_ratio > volume_threshold:
                print(f"âŒ {security} æˆäº¤é‡è¾ƒè¿‘{days}æ—¥å‡å€¼ x{_volume_ratio:.2f}")
                return _volume_ratio
            print(f"âœ”ï¸ {security} æˆäº¤é‡è¾ƒè¿‘{days}æ—¥å‡å€¼ x{_volume_ratio:.2f}")

        except Exception as e:
            print(f"â­• æ£€æŸ¥{security}æˆäº¤é‡å¤±è´¥: {e}")
            return

    res = []
    for stock in stock_list:
        ratio = _get_volume_ratio(stock)
        if not ratio:
            res.append(stock)

    return res


# RSRS å‡çº¿è¿‡æ»¤
def filter_rsrs(stock_list):
    print("ETF RSRS+å‡çº¿è¿‡æ»¤ " + "*" * 60)

    # è®¡ç®—æ–œç‡
    def _get_slope(security, days=18):
        try:
            hist_data = attribute_history(security, days, '1d', ['high', 'low'])
            if hist_data.empty or len(hist_data) < days:
                return None
            slope = np.polyfit(hist_data['low'].values, hist_data['high'].values, 1)[0]
            return slope
        except Exception as e:
            print(f"è®¡ç®—{security} RSRSæ–œç‡å¤±è´¥: {e}")
            return None

    # è®¡ç®—é˜ˆå€¼
    def _get_beta(security, lookback_days=250, window=20):
        try:
            hist_data = attribute_history(security, lookback_days, '1d', ['high', 'low'])
            if hist_data.empty or len(hist_data) < lookback_days:
                return

            slope_list = []
            for i in range(len(hist_data) - window + 1):
                window_data = hist_data.iloc[i:i + window]
                low_values = window_data['low'].values
                high_values = window_data['high'].values

                if len(low_values) < window or len(high_values) < window:
                    continue
                if np.any(np.isnan(low_values)) or np.any(np.isnan(high_values)):
                    continue
                if np.any(np.isinf(low_values)) or np.any(np.isinf(high_values)):
                    continue
                if np.std(low_values) == 0 or np.std(high_values) == 0:
                    continue

                slope = np.polyfit(low_values, high_values, 1)[0]
                slope_list.append(slope)

            if len(slope_list) < 2:
                return None

            mean_slope = np.mean(slope_list)
            std_slope = np.std(slope_list)
            beta = mean_slope - 2 * std_slope
            return beta
        except Exception as e:
            print(f"è®¡ç®—{security} RSRS Betaå¤±è´¥: {e}")
            return None

    # è®¡ç®—å¼ºåº¦
    def _check_with_strength(security):
        _slope = _get_slope(security)
        _beta = _get_beta(security)
        if _slope is None or _beta is None:
            return None, 0
        _strength = (_slope - _beta) / abs(_beta) if _beta != 0 else 0
        return _slope > _beta, _strength

    # è®¡ç®—å‡å€¼
    def _check_above_ma(security, days=20):
        try:
            hist = attribute_history(security, days, "1d", ["close"])
            if len(hist) < days:
                return False
            current_price = get_current_data()[security].last_price
            return current_price >= hist["close"].mean()
        except Exception as e:
            print(f"è®¡ç®—{security} {days}æ—¥å‡çº¿å¤±è´¥: {e}")
            return False

    res = []
    for stock in stock_list:
        stock_pass, stock_strength = _check_with_strength(stock)
        above_ma_5 = _check_above_ma(stock, 5)
        above_ma_10 = _check_above_ma(stock, 10)
        flag = "âŒ"
        if stock_pass:
            if stock_strength > 0.15:
                flag = "âœ”ï¸"
                res.append(stock)
            elif stock_strength > 0.03 and above_ma_5:
                flag = "âœ”ï¸"
                res.append(stock)
            elif above_ma_10:
                flag = "âœ”ï¸"
                res.append(stock)
        print(f"{flag}  {format_stock_code(stock)} "
              f"pass:{stock_pass}  strength:{stock_strength:.2f} "
              f"ma5: {above_ma_5}  ma10: {above_ma_5}")
    return res


def get_etf_rank(context, etf_pool):
    rank_list = []
    # è¿‡æ»¤è¿‘3æ—¥è·Œå¹…è¶…è¿‡5%çš„ETF
    current_data = get_current_data()
    print("ETF è·Œå¹…æ£€æµ‹ " + "*" * 60)
    for etf in etf_pool:
        df = attribute_history(etf, g.m_days, "1d", ["close", "high"])
        prices = np.append(df["close"].values, current_data[etf].last_price)
        if min(prices[-1] / prices[-2],
               prices[-2] / prices[-3],
               prices[-3] / prices[-4]) < 0.95:
            print(f"âŒ {format_stock_code(etf)} è¿‘3æ—¥è·Œå¹…è¶…è¿‡5%, å·²æ’é™¤")
            continue
        # æ—¥å†…æ­¢æŸ, è·ç¦»å¼€ç›˜æš´è·Œçš„ä¸è¿›è¡Œä¹°å…¥
        if g.enable_stop_loss_by_cur_day:
            ratio = cal_cur_to_open_ratio(etf)
            if ratio <= g.stoploss_limit_by_cur_day:
                print(f"âŒ {format_stock_code(etf)} è¿›å…¥è·Œå¹…è¾¾åˆ° {ratio * 100:.2f}%, å·²æ’é™¤")
                continue
        print(f"âœ”ï¸ {format_stock_code(etf)} æ£€æµ‹é€šè¿‡")
        rank_list.append(etf)
    # è¿‡æ»¤ RSRS + å‡å€¼
    rank_list = filter_rsrs(rank_list)
    # è¿‡æ»¤æˆäº¤é‡å¼‚å¸¸
    rank_list = filter_volume(context, rank_list)
    # è¿‡æ»¤ åŠ¨é‡å¾—åˆ†, ( 0 ~ 5 )
    rank_list = filter_moment_rank(rank_list, g.m_days, 0, g.m_score)

    res_list = []
    # è¿‡æ»¤ RSI
    for etf in rank_list:
        # è¿‡çƒ­çš„ä¸ä¹°å…¥
        if calculate_rsi(etf) < 80:
            res_list.append(etf)
    return res_list


def strategy_3_sell(context):
    # è·å–åŠ¨é‡æœ€é«˜çš„ETF
    rank_df = get_etf_rank(context, g.etf_pool_3)

    # é€‰ä¸å‡ºæ¥åˆé€‚çš„å°±æ¸…ä»“
    if not rank_df:
        for current_etf in g.strategy_holdings[3]:
            print("ğŸ‘¿ğŸ‘¿ğŸ‘¿ğŸ‘¿ğŸ‘¿ ETFè½®åŠ¨æ²¡æœ‰ä¸€ä¸ªèƒ½æ‰“çš„, æ¸…ä»“å½“å‰æŒä»“")
            close_position(current_etf)
            g.strategy_holdings[3] = []
        return
    g.buy_etf = None
    select_etf = rank_df[0]
    current_etf = None

    # æ£€æŸ¥å½“å‰æŒä»“
    for asset in context.portfolio.positions:
        if asset in g.etf_pool_3:
            current_etf = asset
            break

    # ç­–ç•¥3ä¸“ç”¨èµ„é‡‘
    strategy_cash = context.portfolio.total_value * g.portfolio_value_proportion[2]

    # éœ€è¦è°ƒä»“çš„æƒ…å†µ
    if current_etf and current_etf != select_etf:
        print(f"ETFè½®åŠ¨è°ƒä»“: {current_etf} -> {select_etf}")
        close_position(current_etf)  # å–æ‰å½“å‰çš„
        g.buy_etf = select_etf
        # open_position(context, g.select_etf, strategy_cash, 3)  # ä¹°å…¥æ–°çš„
    # é¦–æ¬¡ä¹°å…¥æˆ–æ¢å¤æŒä»“
    elif not current_etf and strategy_cash > 0:
        g.buy_etf = select_etf
        print(f"ETFè½®åŠ¨å»ºä»“: {select_etf}")
        # open_position(context, select_etf, strategy_cash, 3)  # ä¹°å…¥æ–°çš„
    g.strategy_holdings[3] = list(set(g.strategy_holdings[3]))


def strategy_3_buy(context):
    if g.buy_etf:
        strategy_cash = context.portfolio.total_value * g.portfolio_value_proportion[2]
        open_position(context, g.buy_etf, strategy_cash, 3)  # ä¹°å…¥æ–°çš„
    g.strategy_holdings[3] = list(set(g.strategy_holdings[3]))


""" ====================== ç­–ç•¥4: ç™½é©¬æ”»é˜² ====================== """


def bm_adjust_position(context):
    if not g.check_out_lists:
        bm_before_market_open(context)
    buy_stocks = g.check_out_lists
    print(f"ç™½é©¬ç›®æ ‡è°ƒä»“: {','.join([f'{format_stock_code(i)}' for i in buy_stocks])}")
    # å–å‡ºä¸åœ¨ç›®æ ‡åˆ—è¡¨ä¸­çš„è‚¡ç¥¨ï¼ˆåªå¤„ç†æœ¬ç­–ç•¥æŒä»“ï¼‰
    for stock in g.strategy_holdings[4][:]:
        current_data = get_current_data()
        # ä¸åœ¨ä¹°å…¥åˆ—è¡¨åˆ™å–å‡º
        if stock not in buy_stocks:
            # æ¶¨åœæ— æ³•å–å‡ºæ—¶è·³è¿‡
            if current_data[stock].last_price >= current_data[stock].high_limit:
                continue
            close_position(stock)
            print(f"ç™½é©¬ç­–ç•¥è°ƒå‡º: {stock}")

    # ä¹°å…¥æ–°æ ‡çš„
    position_count = len([s for s in context.portfolio.positions.keys()
                          if s in g.strategy_holdings[4]])
    if len(buy_stocks) > position_count:
        # ä½¿ç”¨ç­–ç•¥4ä¸“ç”¨èµ„é‡‘
        value = context.portfolio.total_value * g.portfolio_value_proportion[3] / g.stock_num_2
        for stock in buy_stocks:
            if stock not in g.strategy_holdings[4]:
                if open_position(context, stock, value, 4):
                    if len(g.strategy_holdings[4]) >= g.stock_num_2:
                        break


# å¸‚åœºæ¸©åº¦åˆ¤æ–­
def cal_market_temperature(context):
    # æ•°æ®å›æ»šä¸¤å¹´åˆ¤æ–­å¸‚åœºæ¸©åº¦
    if not hasattr(g, 'market_temperature'):
        long_index300 = list(attribute_history('000300.XSHG', 220 * 3, '1d', ('close',), df=False)['close'])
        g.market_temperature = 'cold'
        for back_day in range(220, len(long_index300)):
            index300 = long_index300[back_day - 220:back_day]
            market_height = (mean(index300[-5:]) - min(index300)) / (max(index300) - min(index300))
            if market_height < 0.20:
                g.market_temperature = "cold"
            elif market_height > 0.80:
                g.market_temperature = "hot"
            elif max(index300[-60:]) / min(index300) > 1.20:
                g.market_temperature = "warm"
    # å½“å‰ä¸€å¹´çš„æ¸©åº¦åˆ¤æ–­
    index300 = attribute_history('000300.XSHG', 220, '1d', ('close',), df=True) \
        .drop(pd.to_datetime("2024-10-08"), errors='ignore')
    index300 = index300['close'].tolist()
    market_height = (mean(index300[-5:]) - min(index300)) / (max(index300) - min(index300))
    if market_height < 0.20:
        g.market_temperature = "cold"
    elif index300[-1] == min(index300):
        g.market_temperature = "cold"
    elif market_height > 0.90:
        g.market_temperature = "hot"
    elif index300[-1] == max(index300):
        g.market_temperature = "hot"
    elif max(index300[-60:]) / min(index300) > 1.20:
        g.market_temperature = "warm"


# å¼€ç›˜å‰è¿è¡Œå‡½æ•°
def bm_before_market_open(context):
    cal_market_temperature(context)
    g.check_out_lists = []
    current_data = get_current_data()
    all_stocks = get_index_stocks("000300.XSHG")  # ä»¥æ²ªæ·±300æˆåˆ†è‚¡å‘³è‚¡ç¥¨æ± è¿›ä¸€æ­¥ç­›é€‰
    # è¿‡æ»¤åˆ›ä¸šæ¿ã€STã€åœç‰Œã€å½“æ—¥æ¶¨åœ
    all_stocks = [stock for stock in all_stocks if not (
            (current_data[stock].last_price > round(
                context.portfolio.total_value * g.portfolio_value_proportion[0] * 0.95 / g.stock_num_2 / 100,
                2)) or  # è‚¡ä»·é™é«˜
            (current_data[stock].day_open == current_data[stock].high_limit) or  # æ¶¨åœå¼€ç›˜
            (current_data[stock].day_open == current_data[stock].low_limit) or  # è·Œåœå¼€ç›˜
            current_data[stock].paused or  # åœç‰Œ
            current_data[stock].is_st or  # ST
            ('ST' in current_data[stock].name) or  # ST
            ('*' in current_data[stock].name) or
            ('é€€' in current_data[stock].name) or
            (stock.startswith('30')) or  # åˆ›ä¸š
            (stock.startswith('68')) or  # ç§‘åˆ›
            (stock.startswith('8')) or  # åŒ—äº¤
            (stock.startswith('4'))  # åŒ—äº¤
    )]
    last_prices = history(1, unit='1d', field='close', security_list=all_stocks)
    all_stocks = [stock for stock in all_stocks if last_prices[stock][-1] <= 100]  # è¿‡æ»¤é«˜ä»·è‚¡

    q = None
    if g.market_temperature == "cold":
        q = query(
            valuation.code,
            indicator.roe,
            indicator.roa
        ).filter(
            valuation.pb_ratio > 0,
            valuation.pb_ratio < 1,
            cash_flow.subtotal_operate_cash_inflow > 0,
            indicator.adjusted_profit > 0,
            cash_flow.subtotal_operate_cash_inflow / indicator.adjusted_profit > 2.0,
            indicator.inc_return > 1.5,
            indicator.inc_net_profit_year_on_year > -15,
            valuation.code.in_(all_stocks)
        ).order_by(
            (indicator.roa / valuation.pb_ratio).desc()
        ).limit(
            50
        )
    elif g.market_temperature == "warm":
        q = query(
            valuation.code,
            indicator.roe,
            indicator.roa
        ).filter(
            valuation.pb_ratio > 0,
            valuation.pb_ratio < 1,
            cash_flow.subtotal_operate_cash_inflow > 0,
            indicator.adjusted_profit > 0,
            cash_flow.subtotal_operate_cash_inflow / indicator.adjusted_profit > 1.0,
            indicator.inc_return > 2.0,
            indicator.inc_net_profit_year_on_year > 0,
            valuation.code.in_(all_stocks)
        ).order_by(
            (indicator.roa / valuation.pb_ratio).desc()
        ).limit(
            50
        )
    elif g.market_temperature == "hot":
        q = query(
            valuation.code,
            indicator.roe,
            indicator.roa
        ).filter(

            valuation.pb_ratio > 3,
            cash_flow.subtotal_operate_cash_inflow > 0,
            indicator.adjusted_profit > 0,
            cash_flow.subtotal_operate_cash_inflow / indicator.adjusted_profit > 0.5,
            indicator.inc_return > 3.0,
            indicator.inc_net_profit_year_on_year > 20,
            valuation.code.in_(all_stocks)
        ).order_by(
            indicator.roa.desc()
        ).limit(
            50  # *10
        )

    """*****************************************************************************************"""
    df = get_fundamentals(q)
    df.index = df['code'].values

    # æŒ‰ç…§å› å­ç»™è‚¡ç¥¨æ’åºï¼ˆç›¸å½“äºå„å› å­å¹³æƒï¼‰
    # pb_rank= df['pb_ratio'].rank(ascending=True)  # å‡åºæ’åï¼ˆpbè¶Šä½è¶Šå¥½ï¼‰
    roe_inv_rank = df['roe'].rank(ascending=False)  # é™åºæ’åï¼ˆroeè¶Šé«˜è¶Šå¥½ï¼‰
    roa_inv_rank = df['roa'].rank(ascending=False)  # é™åºæ’åï¼ˆroaè¶Šé«˜è¶Šå¥½ï¼‰

    # åº”ç”¨æƒé‡è®¡ç®—ç»¼åˆå¾—åˆ†
    df['point'] = (g.roe * roe_inv_rank + g.roa * roa_inv_rank)

    # æŒ‰å¾—åˆ†è¿›è¡Œæ’åºï¼Œå–æŒ‡å®šæ•°é‡çš„è‚¡ç¥¨
    df = df.sort_values(by='point')  # [:g.buy_stock_count]

    check_out_lists = list(df.code)
    """*****************************************************************************************"""
    # åŠ¨é‡è¶‹åŠ¿è¿‡æ»¤ï¼Œå‰”é™¤å¤ªé«˜å’Œå¤ªä½çš„
    check_out_lists2 = moment_rank(check_out_lists, 25, -1.0, 10.5)
    # é¡ºåºè¿˜æ˜¯æŒ‰ç…§åŠ¨é‡è¶‹æ»¤å‰åŸæ¥çš„é¡ºåº
    check_out_lists = [x for x in check_out_lists if x in check_out_lists2]
    g.check_out_lists = check_out_lists[:g.stock_num_2]
    print("ä»Šæ—¥å¸‚åœºæ¸©åº¦ï¼š%s" % g.market_temperature)
    print("ä»Šæ—¥ç™½é©¬è‚¡ç¥¨æ± ï¼š%s" % g.check_out_lists)


# åŠ¨é‡è®¡ç®—
def moment_rank(stock_pool, days, ll, hh):
    # - å¯¹è‚¡ç¥¨è¿‘dayså¤©çš„æ”¶ç›˜ä»·å–å¯¹æ•°ï¼Œè¿›è¡ŒåŠ æƒçº¿æ€§å›å½’ï¼ˆè¿‘æœŸæƒé‡é«˜ï¼‰ã€‚
    # - è®¡ç®—å¹´åŒ–æ”¶ç›Šç‡ï¼ˆæŒ‡æ•°åŒ–æ–œç‡ï¼‰å’ŒRå¹³æ–¹ï¼ˆè¶‹åŠ¿å¼ºåº¦ï¼‰ã€‚
    # - åŠ¨é‡å¾—åˆ† = å¹´åŒ–æ”¶ç›Šç‡Ã—Rå¹³æ–¹ã€‚

    def mom(_stock):
        y = np.log(attribute_history(_stock, days, '1d', ['close'], df=False)['close'])
        n = len(y)
        x = np.arange(n)
        weights = np.linspace(1, 2, n)
        slope, intercept = np.polyfit(x, y, 1, w=weights)
        annualized_returns = math.pow(math.exp(slope), 250) - 1
        residuals = y - (slope * x + intercept)
        weighted_residuals = weights * residuals ** 2
        r_squared = 1 - (np.sum(weighted_residuals) / np.sum(weights * (y - np.mean(y)) ** 2))
        return annualized_returns * r_squared

    score_list = []
    for stock in stock_pool:
        score = mom(stock)
        score_list.append(score)
    df = pd.DataFrame(index=stock_pool, data={'score': score_list})
    df = df.sort_values(by='score', ascending=False)  # é™åº
    df = df[(df['score'] > ll) & (df['score'] < hh)]
    rank_list = list(df.index)
    return rank_list


""" ====================== è¾…åŠ©çš„å®šæ—¶æ‰§è¡Œå‡½æ•° ====================== """


# å¤§ç›˜é¡¶èƒŒç¦»
def check_dbl(context, market_index='399101.XSHE', end_days=0):
    """
        å¤§ç›˜é¡¶èƒŒç¦»æ£€æµ‹ï¼šé€šè¿‡MACDåˆ¤æ–­å¸‚åœºæ½œåœ¨åè½¬é£é™©
        ç›®çš„ï¼šåœ¨å¤§ç›˜å‡ºç°é¡¶èƒŒç¦»ï¼ˆä¸Šæ¶¨ä¹åŠ›ï¼‰æ—¶æå‰å‡ä»“ï¼Œè§„é¿ç³»ç»Ÿæ€§ä¸‹è·Œ
    """
    # æŠŠç¬¬ä¸€æ¬¡9:31æ‰§è¡Œçš„ç»™å¿½ç•¥æ‰, ç¬¬ä¸€æ¬¡9:49ä¼šå›æº¯è¿‡å»10å¤©, é¿å…ç¬¬ä¸€æ¬¡é€ æˆå¹²æ‰°(å…¶å®ä¹Ÿä¸ä¼š, ä½†çœ‹æ—¥å¿—ä¼šçœ‹çš„ä¸ä¼šæœ‰å›°æƒ‘)
    if not g.dbl and "9:31" in str(context.current_dt.time()):
        return

    def detect_divergence():
        """æ£€æµ‹é¡¶èƒŒç¦»ï¼ˆä»·æ ¼æ–°é«˜ä½†MACDæŒ‡æ ‡èµ°å¼±ï¼Œé¢„ç¤ºè¶‹åŠ¿åè½¬ï¼‰
        æ¡ä»¶ï¼š
        1. ä»·æ ¼åˆ›æ–°é«˜ï¼ˆåé«˜>å‰é«˜ï¼‰
        2. MACDæŒ‡æ ‡æœªåˆ›æ–°é«˜ï¼ˆåä½<å‰ä½ï¼‰
        3. MACDç”±æ­£è½¬è´Ÿï¼ˆè¶‹åŠ¿è½¬å¼±ï¼‰
        4. DIFå¤„äºä¸‹é™è¶‹åŠ¿ï¼ˆè¿‘æœŸå‡å€¼<å‰æœŸå‡å€¼ï¼‰
        """
        fast, slow, sign = 12, 26, 9  # MACDå‚æ•°
        rows = (fast + slow + sign) * 5  # ç¡®ä¿è¶³å¤Ÿæ•°æ®é‡ï¼ˆçº¦1å¹´ï¼‰
        # è·å–å†å²æ”¶ç›˜ä»·æ•°æ®
        grid = attribute_history(market_index, rows + 10, fields=['close']).dropna()
        if end_days < 0:
            grid = grid.iloc[:end_days]

        if len(grid) < rows:
            print(f"{market_index} æ•°æ®ä¸è¶³ {rows} å¤©ï¼Œæ— æ³•æ£€æµ‹é¡¶èƒŒç¦»")
            return False

        try:
            # è®¡ç®—MACDæŒ‡æ ‡
            grid['dif'], grid['dea'], grid['macd'] = mcad(grid.close, fast, slow, sign)

            # å¯»æ‰¾æ­»å‰ç‚¹ï¼ˆMACDç”±æ­£è½¬è´Ÿçš„æ—¶åˆ»ï¼‰
            mask = (grid['macd'] < 0) & (grid['macd'].shift(1) >= 0)
            if mask.sum() < 2:  # éœ€è¦è‡³å°‘2ä¸ªæ­»å‰ç‚¹å¯¹æ¯”
                print(f"{market_index} æ­»å‰ç‚¹ä¸è¶³2ä¸ªï¼Œæ— æ³•æ£€æµ‹é¡¶èƒŒç¦»")
                return False

            # å–æœ€è¿‘ä¸¤ä¸ªæ­»å‰ç‚¹ï¼ˆå‰ä¸€ä¸ªä¸å½“å‰ï¼‰
            key2, key1 = mask[mask].index[-2], mask[mask].index[-1]

            # é¡¶èƒŒç¦»æ ¸å¿ƒæ¡ä»¶
            price_cond = grid.close[key2] < grid.close[key1]  # ä»·æ ¼åˆ›æ–°é«˜ï¼ˆåé«˜>å‰é«˜ï¼‰
            dif_cond = grid.dif[key2] > grid.dif[key1] > 0  # DIFæœªåˆ›æ–°é«˜ï¼ˆåä½<å‰é«˜ï¼‰ä¸”ä¸ºæ­£
            macd_cond = grid.macd.iloc[-2] > 0 > grid.macd.iloc[-1]  # MACDç”±æ­£è½¬è´Ÿ

            # è¶‹åŠ¿éªŒè¯ï¼šDIFè¿‘æœŸå¤„äºä¸‹é™è¶‹åŠ¿ï¼ˆè¿‘10æ—¥å‡å€¼<å‰10æ—¥å‡å€¼ï¼‰
            if len(grid['dif']) > 20:
                recent_avg = grid['dif'].iloc[-10:].mean()  # è¿‘10æ—¥DIFå‡å€¼
                prev_avg = grid['dif'].iloc[-20:-10].mean()  # å‰10æ—¥DIFå‡å€¼
                trend_cond = recent_avg < prev_avg
            else:
                trend_cond = False

            # print(f"{market_index} é¡¶èƒŒç¦»æ£€æµ‹: ä»·æ ¼åˆ›æ–°é«˜={price_cond}, DIFæœªæ–°é«˜={dif_cond}, "
            #       f"MACDè½¬è´Ÿ={macd_cond}, DIFä¸‹é™è¶‹åŠ¿={trend_cond}")
            return price_cond and dif_cond and macd_cond and trend_cond

        except Exception as e:
            print(f"{market_index} é¡¶èƒŒç¦»æ£€æµ‹é”™è¯¯: {e}")
            return False

    # éå°å¸‚å€¼åªè®¡ç®—åˆ¤æ–­, ä¸åšä»“ä½å¤„ç†
    if market_index != '399101.XSHE':
        res = 1 if detect_divergence() else 0
        if res:
            print(f"{market_index} è§¦å‘é¡¶èƒŒç¦»äº†!!!!! å¿«è·‘ !!!!!")
        return res

    if detect_divergence():
        g.dbl.append(1)
        print(f"âš ï¸âš ï¸âš ï¸âš ï¸âš ï¸ æ£€æµ‹åˆ°{market_index}é¡¶èƒŒç¦»ä¿¡å·ï¼ˆä»·æ ¼æ–°é«˜ä½†MACDèµ°å¼±ï¼‰ï¼Œæ¸…ä»“éæ¶¨åœè‚¡ç¥¨")

        # ä»…ä¿ç•™å½“å‰æ¶¨åœè‚¡ï¼ˆå¯èƒ½å»¶ç»­å¼ºåŠ¿ï¼‰ï¼Œæ¸…ä»“å…¶ä»–è‚¡ç¥¨
        current_data = get_current_data()

        # ä»…å¯¹å°å¸‚å€¼è¿›è¡Œå¤„ç†
        for stock in g.strategy_holdings[1][:]:
            # å½“å‰æœªæ¶¨åœçš„è‚¡ç¥¨æ¸…ä»“
            if current_data[stock].last_price < current_data[stock].high_limit:
                print(f"{stock} å› å¤§ç›˜é¡¶èƒŒç¦»æ¸…ä»“ï¼ˆéæ¶¨åœè‚¡ï¼‰")
                close_position(stock)
    else:
        g.dbl.append(0)
        # print(f"æœªæ£€æµ‹åˆ°å¤§ç›˜é¡¶èƒŒç¦»ï¼Œå¸‚åœºè¶‹åŠ¿æ­£å¸¸, æœ€è¿‘çš„é¡¶èƒŒç¦»è®°å½•: {g.dbl[-g.check_dbl_days:]}")


# å°¾ç›˜è®°å½•å„ä¸ªç­–ç•¥çš„æ”¶ç›Š
def make_record(context):
    positions = context.portfolio.positions
    if not positions:
        return
    current_data = get_current_data()
    g.strategy_value_data = {1: 0, 2: 0, 3: 0, 4: 0}
    # å¤åˆ¶ä¸€ä¸ªæ˜¨å¤©çš„è®°å½•è¿›è¡Œç´¯è®¡
    copy_strategy_value = {
        1: g.strategy_value[1],
        2: g.strategy_value[2],
        3: g.strategy_value[3],
        4: g.strategy_value[4],
    }
    for stock, pos in positions.items():
        strategy_id = g.stock_strategy[stock]
        current_value = pos.total_amount * current_data[stock].last_price  # å½“å‰ä»·å€¼
        cost_value = pos.total_amount * pos.avg_cost  # æˆæœ¬ä»·å€¼
        pnl_value = current_value - cost_value  # å½“å‰ç›ˆäºé‡‘é¢
        copy_strategy_value[strategy_id] += pnl_value  # è®¡ç®—æµ®ç›ˆæµ®äº
        g.strategy_value_data[strategy_id] += current_value
    if g.portfolio_value_proportion[0]:
        record(å°å¸‚å€¼=round(copy_strategy_value[1] / g.strategy_starting_cash[1] * 100 - 100, 2))
    if g.strategy_ETF_2000_proportion:
        record(ETFåå¼¹=round(copy_strategy_value[2] / g.strategy_starting_cash[2] * 100 - 100, 2))
    if g.portfolio_value_proportion[2]:
        record(ETFè½®åŠ¨=round(copy_strategy_value[3] / g.strategy_starting_cash[3] * 100 - 100, 2))
    if g.portfolio_value_proportion[3]:
        record(ç™½é©¬æ”»é˜²=round(copy_strategy_value[4] / g.strategy_starting_cash[4] * 100 - 100, 2))

    # æ”¶ç›˜åå†æŠŠETFè½®åŠ¨çš„æ˜æ—¥é€‰è‚¡æå‰é€æ¼ä¸‹
    if g.portfolio_value_proportion[2]:
        print("æ”¶ç›˜åæ£€æµ‹ä¸‹æœ€æ–°çš„ETFåŠ¨é‡æ’å, æ–¹ä¾¿æ˜å¤©å‚è€ƒ")
        filter_moment_rank(g.etf_pool_3, g.m_days, 0, g.m_score)


# åˆ¶è¡¨å±•ç¤ºæ¯æ—¥æ”¶ç›Š
def print_summary(context):
    """
    æ‰“å°å½“å‰æŠ•èµ„ç»„åˆçš„æ€»èµ„äº§å’ŒæŒä»“è¯¦æƒ…

    å‚æ•°:
        context: åŒ…å«æŠ•èµ„ç»„åˆä¿¡æ¯çš„å¯¹è±¡ã€‚
        get_current_data: è·å–å½“å‰å¸‚åœºæ•°æ®çš„å‡½æ•°ã€‚
    """
    # è·å–æ€»èµ„äº§
    total_value = round(context.portfolio.total_value, 2)

    # è·å–å½“å‰æŒä»“
    current_stocks = context.portfolio.positions
    if not current_stocks:
        # å¦‚æœæ²¡æœ‰æŒä»“ï¼Œåªæ˜¾ç¤ºæ€»èµ„äº§
        print(f"ğŸš¤ğŸš¤ğŸš¤ğŸš¤ğŸš¤ å½“å‰æ€»èµ„äº§: {total_value} ä¼‘æ¯ing ")
        return

    # åˆ›å»ºè¡¨æ ¼
    table = PrettyTable([
        " æ‰€å±ç­–ç•¥ ",
        " è‚¡ç¥¨ä»£ç  ",
        " è‚¡ç¥¨åç§° ",
        " æŒä»“æ•°é‡ ",
        " æŒä»“ä»·æ ¼ ",
        " å½“å‰ä»·æ ¼ ",
        " ç›ˆäºæ•°é¢ ",
        " ç›ˆäºæ¯”ä¾‹ ",
        " è‚¡ç¥¨å¸‚å€¼ ",
        " ä»“ä½å æ¯” "])
    table.hrules = prettytable.ALL  # æ˜¾ç¤ºæ‰€æœ‰æ°´å¹³çº¿

    # # è®¾ç½®å¯¹é½æ–¹å¼
    # table.align["æ‰€å±ç­–ç•¥    "] = "l"
    # table.align["è‚¡ç¥¨ä»£ç     "] = "l"
    # table.align["è‚¡ç¥¨åç§°  "] = "l"
    # for field in ["æŒä»“æ•°é‡  ", "æŒä»“ä»·æ ¼  ", "å½“å‰ä»·æ ¼  ", "ç›ˆäºæ•°é¢  ", "ç›ˆäºæ¯”ä¾‹  ", "å¸‚å€¼  ", "ä»“ä½å æ¯”  "]:
    #     table.align[field] = "r"

    # éå†æŒä»“è‚¡ç¥¨
    total_market_value = 0  # æ€»å¸‚å€¼ï¼ˆç”¨äºç´¯åŠ æ¯åªè‚¡ç¥¨çš„å¸‚å€¼ï¼‰
    for stock in current_stocks:
        current_shares = current_stocks[stock].total_amount  # æŒä»“æ•°é‡
        current_price = round(get_current_data()[stock].last_price, 3)  # å½“å‰ä»·æ ¼
        avg_cost = round(current_stocks[stock].avg_cost, 3)  # æŒä»“å¹³å‡æˆæœ¬

        # è®¡ç®—ç›ˆäºæ¯”ä¾‹
        profit_ratio = (current_price - avg_cost) / avg_cost if avg_cost != 0 else 0
        profit_ratio_percent = f"{profit_ratio * 100:.2f}%"  # è½¬ä¸ºç™¾åˆ†æ¯”å¹¶ä¿ç•™ä¸¤ä½å°æ•°
        profit_ratio_percent += f" {'â†‘' if profit_ratio > 0 else 'â†“'}"
        # è®¡ç®—ç›ˆäºæ•°é¢
        profit_amount = round((current_price - avg_cost) * current_shares, 2)

        # è®¡ç®—å¸‚å€¼
        market_value = round(current_shares * current_price, 2)
        total_market_value += market_value  # ç´¯åŠ æ€»å¸‚å€¼

        # å¤„ç†è‚¡ç¥¨ä»£ç ï¼šç§»é™¤åç¼€
        stock_code = stock.split(".")[0]  # åªä¿ç•™è‚¡ç¥¨ä»£ç éƒ¨åˆ†

        # æ·»åŠ åˆ°è¡¨æ ¼
        table.add_row([
            g.stock_strategy[stock],
            stock_code,
            format_stock_code(stock),
            current_shares,
            avg_cost,
            current_price,
            profit_amount,
            profit_ratio_percent,
            market_value,
            f"{market_value / context.portfolio.total_value * 100:.2f}%"
        ])

    # è´¦æˆ·æ€»èµ„äº§
    total_value = context.portfolio.total_value
    # æ±‡æ€»
    if g.strategy_value_data[1]:
        table.add_row(["å°å¸‚å€¼", "", "", "", "", "", "", "", f"{g.strategy_value_data[1]:.2f}",
                       f"{g.strategy_value_data[1] / total_value * 100:.2f}%"])
    if g.strategy_value_data[2]:
        table.add_row(["ETFåå¼¹", "", "", "", "", "", "", "", f"{g.strategy_value_data[2]:.2f}",
                       f"{g.strategy_value_data[2] / total_value * 100:.2f}%"])
    if g.strategy_value_data[3]:
        table.add_row(["ETFè½®åŠ¨", "", "", "", "", "", "", "", f"{g.strategy_value_data[3]:.2f}",
                       f"{g.strategy_value_data[3] / total_value * 100:.2f}%"])
    if g.strategy_value_data[4]:
        table.add_row(["ç™½é©¬æ”»é˜²", "", "", "", "", "", "", "", f"{g.strategy_value_data[4]:.2f}",
                       f"{g.strategy_value_data[4] / total_value * 100:.2f}%"])
    table.add_row(["æ€»å¸‚å€¼", "", "", "", "", "", "", "", f"{total_market_value:.2f}", ""])
    table.add_row(["æ€»èµ„äº§", "", "", "", "", "", "", "", f"{total_value:.2f}", ""])

    # æ‰“å°è¡¨æ ¼
    print(f'å½“å‰æ€»èµ„äº§\n{table}')


# å°å¸‚å€¼æ¢æ‰‹æ£€æµ‹
def xsz_huanshou_check(context):
    huanshou(context, stock_list=g.strategy_holdings[1][:])


# ETFè½®åŠ¨æ—¥å†…æ­¢æŸæ£€æµ‹
def etf_stop_loss_by_cur_day(context):
    holdings = set(g.strategy_holdings[3])
    # æ£€æµ‹æ—¥å†…äºæŸ
    stop_loss_by_cur_day(holdings, ratio=g.stoploss_limit_by_cur_day)


""" ====================== å…¬å…±å‡½æ•° ====================== """


# å°è£…å®ç›˜ä¸‹å•å‡½æ•°
def my_order_target_value(security, value):
    o = order_target_value(security, value)
    if o:
        if o.is_buy:
            if o.price * o.amount > 0:
                print(f"ğŸššğŸššğŸššğŸššğŸšš {format_stock_code(security)}  "
                      f"ä¹°ä»·{o.price:<7.2f}  "
                      f"ä¹°é‡{o.amount:<7}   "
                      f"ä»·å€¼{o.price * o.amount:.2f}")
                return o
        else:
            if o.price * o.amount > 0:
                print(f"ğŸš›ğŸš›ğŸš›ğŸš›ğŸš› {format_stock_code(security)}  "
                      f"å–ä»·{o.price:<7.2f}  "
                      f"æˆæœ¬{o.avg_cost:<7.2f}   "
                      f"å–é‡{o.amount:<7}   "
                      f"ç›ˆäº{(o.price - o.avg_cost) * o.amount:.2f}"
                      f"( {(o.price - o.avg_cost) / o.avg_cost * 100:.2f}% )")
                return o


# å¼€ä»“ä¹°å…¥å¹¶è®°å½•ç­–ç•¥æŒä»“
def open_position(context, security, value, strategy_id):
    if value <= 5000:
        # print(f"ä¹°å…¥é‡‘é¢{value}è¾ƒå°, ä¸è¿›è¡Œä¹°å…¥")
        return
    if security in context.portfolio.positions:
        security_value = context.portfolio.positions[security].value
        if abs(value - security_value) < 5000:
            # print(f"ä¹°å…¥å·®é¢{value - security_value}è¾ƒå°, ä¸è¿›è¡Œä¹°å…¥")
            return
    order = my_order_target_value(security, value)
    if order:
        security not in g.strategy_holdings[strategy_id] and g.strategy_holdings[strategy_id].append(security)
        g.stock_strategy[security] = strategy_id
    return order


# é—­ä»“å–å‡ºå¹¶æ¸…ç©ºç­–ç•¥æŒä»“
def close_position(security):
    order = my_order_target_value(security, 0)
    if order:
        strategy_id = g.stock_strategy[security]
        # æŒä»“åˆ—è¡¨ç§»é™¤
        security in g.strategy_holdings[strategy_id] and g.strategy_holdings[strategy_id].remove(security)
        # è®¡ç®—å–å‡ºçš„ç›ˆäº
        pnl_value = (order.price - order.avg_cost) * order.amount
        # æ¯æ—¥ç­–ç•¥æ€»ä»·å€¼æ›´æ–°ç›ˆäº
        g.strategy_value[strategy_id] += pnl_value
    return order


# æ—¥å†…æ­¢æŸ
def stop_loss_by_cur_day(stock_list, ratio=-0.03):
    for stock in stock_list:
        cur_ratio = cal_cur_to_open_ratio(stock)
        if cur_ratio < ratio:
            print(f"{format_stock_code(stock)} è·ç¦»å¼€ç›˜è·Œå¹… {cur_ratio * 100:.2f}% æ¸…ä»“å¤„ç†")
            close_position(stock)


""" ====================== æ¨¡å—å·¥å…·å‡½æ•° ====================== """


# å±•ç¤ºä¼˜åŒ–
def format_stock_code(stock_code):
    try:
        stock_info = get_security_info(stock_code)
    except Exception:
        return f"{stock_code[:6]}"
    return f"{stock_code[:6]}({stock_info.display_name}) "


# ç­›é€‰å®¡è®¡æ„è§
def filter_audit(context, code_list):
    # è·å–å®¡è®¡æ„è§ï¼Œè¿‘ä¸‰å¹´å†…å¦‚æœæœ‰ä¸åˆæ ¼(report_typeä¸º3ã€4ã€5ã€7)çš„å®¡è®¡æ„è§åˆ™è¿”å›Falseï¼Œå¦åˆ™è¿”å›True
    final_list = []
    '''
    å®¡è®¡æ„è§ç±»å‹ç¼–ç 
        ç±»å‹ç¼–ç  å®¡è®¡æ„è§ç±»å‹
        1 	     æ— ä¿ç•™
        2 	     æ— ä¿ç•™å¸¦è§£é‡Šæ€§è¯´æ˜
        3        ä¿ç•™æ„è§
        4        æ‹’ç»/æ— æ³•è¡¨ç¤ºæ„è§
        5        å¦å®šæ„è§
        6 	     æœªç»å®¡è®¡
        7 	     ä¿ç•™å¸¦è§£é‡Šæ€§è¯´æ˜
        10 	     ç»å®¡è®¡ï¼ˆä¸ç¡®å®šå…·ä½“æ„è§ç±»å‹ï¼‰
        11       æ— ä¿ç•™å¸¦æŒç»­ç»è¥é‡å¤§ä¸ç¡®å®šæ€§
    '''
    for stock in code_list:
        previous_date = context.previous_date
        last_year = (previous_date.replace(year=previous_date.year - 3, month=1, day=1)).strftime('%Y-%m-%d')
        q = query(finance.STK_AUDIT_OPINION.code, finance.STK_AUDIT_OPINION.pub_date, finance.STK_AUDIT_OPINION) \
            .filter(finance.STK_AUDIT_OPINION.code == stock, finance.STK_AUDIT_OPINION.pub_date >= last_year)
        df = finance.run_query(q)
        values_to_check = [3, 4, 5, 7]
        if not df['opinion_type_id'].isin(values_to_check).any():
            final_list.append(stock)
    return final_list


# è·å–çº¢åˆ©åˆ—è¡¨
def bonus_filter(context, stock_list):
    year = context.previous_date.year
    start_date = datetime.datetime(year=year, month=1, day=1)
    end_date = context.previous_date
    if end_date.month in [5]:
        q = query(finance.STK_XR_XD.code, finance.STK_XR_XD.company_name, finance.STK_XR_XD.board_plan_pub_date,
                  finance.STK_XR_XD.bonus_amount_rmb, finance.STK_XR_XD.bonus_ratio_rmb
                  ).filter(
            # finance.STK_XR_XD.bonus_type !='å¹´åº¦åˆ†çº¢',
            finance.STK_XR_XD.board_plan_pub_date > start_date,
            finance.STK_XR_XD.implementation_pub_date <= end_date,
            # finance.STK_XR_XD.a_xr_date < context.previous_date,
            finance.STK_XR_XD.bonus_ratio_rmb > 0,
            finance.STK_XR_XD.code.in_(stock_list))
        expected_bonus_df = finance.run_query(q)

        if len(expected_bonus_df) > 0:
            bonus_list = expected_bonus_df['code'].unique().tolist()
            price_df = history(1, unit='1d', field='close', security_list=bonus_list, df=True, skip_paused=False,
                               fq='pre')
            price_df = price_df.T
            price_df.rename(columns={price_df.columns[0]: 'Close_now'}, inplace=True)
            price_df['code'] = price_df.index
            expected_bonus_df = pd.merge(expected_bonus_df, price_df, on=('code',), how='left')
            expected_bonus_df['bonus_ratio'] = (expected_bonus_df['bonus_ratio_rmb']) / expected_bonus_df['Close_now']
            expected_bonus_df = expected_bonus_df.sort_values(by='bonus_ratio', ascending=True)
            bonus_list = expected_bonus_df['code'].unique().tolist()
        else:
            bonus_list = []
    else:
        reprot_date = datetime.datetime(year=year - 1, month=12, day=31)
        q = query(finance.STK_XR_XD.code, finance.STK_XR_XD.company_name, finance.STK_XR_XD.a_registration_date,
                  finance.STK_XR_XD.bonus_amount_rmb, finance.STK_XR_XD.bonus_ratio_rmb
                  ).filter(
            finance.STK_XR_XD.report_date == reprot_date,
            finance.STK_XR_XD.bonus_type == 'å¹´åº¦åˆ†çº¢',
            finance.STK_XR_XD.implementation_pub_date <= end_date,
            finance.STK_XR_XD.board_plan_bonusnote == 'ä¸åˆ†é…ä¸è½¬å¢',
            finance.STK_XR_XD.code.in_(stock_list))

        no_year_bonus = finance.run_query(q)
        no_year_bonus_list = no_year_bonus['code'].unique().tolist()
        # æ’é™¤ä»Šå¹´ä¸åˆ†çº¢çš„è‚¡ç¥¨
        bonus_list = [code for code in stock_list if code not in no_year_bonus_list]
        bonus_list = short_by_market_cap(context, bonus_list)

    if len(bonus_list) < g.xsz_stock_num:
        bonus_list.extend([x for x in short_by_market_cap(context, stock_list) if x not in bonus_list][
                          :g.xsz_stock_num - len(bonus_list)])
    return bonus_list


# è®¡ç®—RSIæŒ‡æ ‡
def calculate_rsi(code, period=14):
    """è®¡ç®—RSIæŒ‡æ ‡"""
    df = attribute_history(code, 125, '1d', ['close', ], skip_paused=True, df=True, fq='pre')
    prices = df['close'].values
    deltas = np.diff(prices)
    seed = deltas[:period + 1]
    up = seed[seed >= 0].sum() / period
    down = -seed[seed < 0].sum() / period
    if down == 0:
        return 100
    rs = up / down
    rsi = 100. - 100. / (1. + rs)
    return rsi


#  åŸºç¡€è¿‡æ»¤å„ç§è‚¡ç¥¨
def filter_stocks(context, stock_list):
    current_data = get_current_data()
    # æ¶¨è·Œåœå’Œæœ€è¿‘ä»·æ ¼çš„åˆ¤æ–­
    last_prices = history(1, unit='1m', field='close', security_list=stock_list)
    # è¿‡æ»¤æ ‡å‡†
    filtered_stocks = []
    for stock in stock_list:
        if current_data[stock].paused:  # åœç‰Œ
            continue
        if current_data[stock].is_st:  # ST
            continue
        if 'é€€' in current_data[stock].name:  # é€€å¸‚
            continue
        if stock.startswith('30') or stock.startswith('68') or stock.startswith('8') or stock.startswith('4'):  # å¸‚åœºç±»å‹
            continue
        if not (stock in context.portfolio.positions or last_prices[stock][-1] < current_data[stock].high_limit):  # æ¶¨åœ
            continue
        if not (stock in context.portfolio.positions or last_prices[stock][-1] > current_data[stock].low_limit):  # è·Œåœ
            continue
        # æ¬¡æ–°è‚¡è¿‡æ»¤
        start_date = get_security_info(stock).start_date
        if context.previous_date - start_date < timedelta(days=375):
            continue
        filtered_stocks.append(stock)
    return filtered_stocks


# è®¡ç®—æœ€æ–°ä»·æ ¼å¯¹æ¯”å¼€ç›˜ä»·æ ¼çš„æ¯”å€¼
def cal_cur_to_open_ratio(security):
    current_data = get_current_data()
    last_price = current_data[security].last_price
    day_open = current_data[security].day_open
    return (last_price - day_open) / day_open


# è®¡ç®—MACDæŒ‡æ ‡
def mcad(close, short=12, long=26, m=9):
    """è®¡ç®— MACD æŒ‡æ ‡
    ç”¨äºåˆ¤æ–­è¶‹åŠ¿å¼ºåº¦å’Œæ½œåœ¨åè½¬ç‚¹ï¼Œç”± DIFã€DEAã€MACD æŸ±ç»„æˆ

    å‚æ•°:
        close: æ”¶ç›˜ä»·åºåˆ—
        short: çŸ­æœŸEMAå‘¨æœŸï¼ˆé»˜è®¤12ï¼‰
        long: é•¿æœŸEMAå‘¨æœŸï¼ˆé»˜è®¤26ï¼‰
        m: ä¿¡å·å‘¨æœŸï¼ˆé»˜è®¤9ï¼‰

    è¿”å›:
        DIF: çŸ­æœŸEMAä¸é•¿æœŸEMAçš„å·®å€¼
        DEA: DIFçš„MæœŸEMA
        MACD: (DIF-DEA)*2ï¼ˆæ”¾å¤§æ³¢åŠ¨ï¼‰
    """

    # è®¡ç®—æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿
    def ema(series, n):
        """è®¡ç®—æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ï¼ˆExponential Moving Averageï¼‰
        ç”¨äºå¹³æ»‘ä»·æ ¼æ³¢åŠ¨ï¼Œåæ˜ è¿‘æœŸä»·æ ¼è¶‹åŠ¿ï¼Œæƒé‡éšæ—¶é—´é€’å‡

        å‚æ•°:
            series: ä»·æ ¼åºåˆ—ï¼ˆå¦‚æ”¶ç›˜ä»·ï¼‰
            N: è®¡ç®—å‘¨æœŸ

        è¿”å›:
            EMAåºåˆ—
        """
        return pd.Series.ewm(series, span=n, min_periods=n - 1, adjust=False).mean()

    dif = ema(close, short) - ema(close, long)
    dea = ema(dif, m)
    return dif, dea, (dif - dea) * 2


# æ¢æ‰‹æ£€æµ‹
def huanshou(context, stock_list):
    # æ¢æ‰‹ç‡è®¡ç®—
    def huanshoulv(_stock, is_avg=False):
        if is_avg:
            # è®¡ç®—å¹³å‡æ¢æ‰‹ç‡
            end_date = context.previous_date
            df_volume = get_price(_stock, end_date=end_date, frequency='daily', fields=['volume'], count=20)
            df_cap = get_valuation(_stock, end_date=end_date, fields=['circulating_cap'], count=1)
            circulating_cap = df_cap['circulating_cap'].iloc[0] if not df_cap.empty else 0
            if circulating_cap == 0:
                return 0.0
            df_volume['turnover_ratio'] = df_volume['volume'] / (circulating_cap * 10000)
            return df_volume['turnover_ratio'].mean()
        else:
            # è®¡ç®—å®æ—¶æ¢æ‰‹ç‡
            date_now = context.current_dt
            df_vol = get_price(_stock, start_date=date_now.date(), end_date=date_now, frequency='1m', fields=['volume'],
                               skip_paused=False, fq='pre', panel=True, fill_paused=False)
            volume = df_vol['volume'].sum()
            date_pre = context.previous_date
            df_circulating_cap = get_valuation(_stock, end_date=date_pre, fields=['circulating_cap'], count=1)
            circulating_cap = df_circulating_cap['circulating_cap'].iloc[0] if not df_circulating_cap.empty else 0
            if circulating_cap == 0:
                return 0.0
            turnover_ratio = volume / (circulating_cap * 10000)
            return turnover_ratio

    current_data = get_current_data()
    shrink, expand = 0.003, 0.1
    # for stock in context.portfolio.positions:
    for stock in stock_list:
        if current_data[stock].paused == True:
            continue
        if current_data[stock].last_price >= current_data[stock].high_limit * 0.97:
            continue
        if context.portfolio.positions[stock].closeable_amount == 0:
            continue
        rt = huanshoulv(stock, False)
        avg = huanshoulv(stock, True)
        if avg == 0:
            continue
        r = rt / avg
        action, icon = '', ''
        if avg < 0.003:
            action, icon = 'ç¼©é‡', 'â„ï¸'
        elif rt > expand and r > 2:
            action, icon = 'æ”¾é‡', 'ğŸ”¥'
        if action:
            print(f"{action} {format_stock_code(stock)}  æ¢æ‰‹ç‡:{rt:.2%}  å‡:{avg:.2%} å€ç‡:x{r:.1f} {icon}")
            close_position(stock)


# æˆäº¤é‡å®½åº¦é˜²å¾¡æ£€æµ‹
def check_defense_trigger(context):
    """æ”¹è¿›åçš„é˜²å¾¡æ¡ä»¶æ£€æŸ¥"""

    # è®¡ç®—å®½åº¦
    def get_market_breadth(ma_days):
        required_days = ma_days + 10
        end_date = context.current_dt.replace(hour=14, minute=49)

        # è·å–è¡Œä¸šåˆ†ç±»æ•°æ®
        sw_l1 = get_industries('sw_l1', date=context.current_dt.date())
        industry_stocks = {}
        for idx, row in sw_l1.iterrows():
            ind_stocks = get_industry_stocks(idx, date=end_date)
            industry_stocks[row['name']] = ind_stocks  # å­˜å‚¨è¡Œä¸šå¯¹åº”çš„è‚¡ç¥¨åˆ—è¡¨

        # è·å–æ‰€æœ‰è‚¡ç¥¨
        all_stocks = []
        for stocks in industry_stocks.values():
            all_stocks.extend(stocks)
        all_stocks = list(set(all_stocks))  # å»é‡

        # è·å–ä»·æ ¼å’Œæˆäº¤é¢æ•°æ®
        data = get_bars(all_stocks, end_dt=end_date, count=required_days, unit='1d',
                        fields=['date', 'close', 'volume', 'money'], include_now=True, df=True)

        # å¤„ç†ä»·æ ¼æ•°æ®ï¼šç”¨level_1ä½œä¸ºç´¢å¼•ï¼ˆè¡Œå·ï¼‰ï¼Œlevel_0ä½œä¸ºè‚¡ç¥¨ä»£ç åˆ—
        price_reset = data.reset_index()
        price_data = price_reset.pivot(index='level_1', columns='level_0', values='close')  # æŒ‰è¦æ±‚çš„é€è§†è¡¨å†™æ³•

        # è®¡ç®—ç§»åŠ¨å¹³å‡å’Œç«™ä¸Šå‡çº¿çš„è‚¡ç¥¨å æ¯”
        ma = price_data.rolling(window=ma_days).mean()
        above_ma = price_data > ma

        # æ ¸å¿ƒé€»è¾‘ï¼šæŒ‰é€è§†è¡¨å¤„ç†20æ—¥æˆäº¤é‡‘é¢ï¼Œè®¡ç®—å¹³å‡å€¼åå†åˆ†ç»„
        # 1. é‡ç½®ç´¢å¼•å¹¶åˆ›å»ºæˆäº¤é¢é€è§†è¡¨ï¼ˆè¡Œ=è¡Œå·ï¼Œåˆ—=è‚¡ç¥¨ä»£ç ï¼Œå€¼=æˆäº¤é¢ï¼‰
        money_reset = data.reset_index()
        money_pivot = money_reset.pivot(index='level_1', columns='level_0', values='money')  # æˆäº¤é¢é€è§†è¡¨

        recent_20d_money_pivot = money_pivot.tail(20)  # å…³é”®ï¼šç›´æ¥ä»é€è§†è¡¨å–æœ€è¿‘20å¤©

        avg_money = recent_20d_money_pivot.mean().reset_index()  # æŒ‰åˆ—æ±‚å¹³å‡
        avg_money.columns = ['code', 'avg_money']  # é‡å‘½ååˆ—ï¼šè‚¡ç¥¨ä»£ç ã€å¹³å‡æˆäº¤é¢

        # 4. æŒ‰å¹³å‡æˆäº¤é¢æ’åºå¹¶åˆ†ä¸º20ç»„
        avg_money = avg_money.sort_values('avg_money', ascending=False)
        # ä½¿ç”¨qcutè¿›è¡Œåˆ†ç»„ï¼Œå¤„ç†å¯èƒ½çš„é‡å¤å€¼
        avg_money['money_group'] = pd.qcut(avg_money['avg_money'], 20, labels=[f'ç»„{i + 1}' for i in range(20)],
                                           duplicates='drop')

        # 5. åˆ›å»ºæˆäº¤é¢åˆ†ç»„å­—å…¸ï¼ˆç»„å: è‚¡ç¥¨åˆ—è¡¨ï¼‰
        money_groups = {group: group_df['code'].tolist()
                        for group, group_df in avg_money.groupby('money_group')}

        # 6. è®¡ç®—æ¯ä¸ªæˆäº¤é¢ç»„ç«™ä¸Šå‡çº¿çš„è‚¡ç¥¨æ¯”ä¾‹
        group_scores = pd.DataFrame(index=price_data.index)
        for group, stocks in money_groups.items():
            valid_stocks = list(set(above_ma.columns) & set(stocks))
            if valid_stocks:
                group_scores[group] = 100 * above_ma[valid_stocks].sum(axis=1) / len(valid_stocks)

        # 7. è®¡ç®—è¿‘3å¤©å„ç»„å¹³å‡ç«™ä¸Šå‡çº¿æ¯”ä¾‹
        recent_group_data = group_scores[-3:].mean()
        _sorted_ma_data = recent_group_data.sort_values(ascending=False)

        # 8. å¤„ç†æ¶¨è·Œå¹…æ•°æ®å’Œæ¯æ—¥æŒ‡æ ‡
        df = data.reset_index().rename(columns={'level_0': 'symbol', 'level_1': 'index'})
        df['pct_change'] = df.groupby(['symbol'])['close'].pct_change()

        trade_days = get_trade_days(end_date=context.current_dt, count=3)
        by_date = trade_days[0]
        df = df[df.date >= by_date]

        grouped = df.groupby('date')
        _result = pd.DataFrame({
            'up_ratio': grouped['pct_change'].apply(lambda x: (x > 0).mean()),
            'down_over': grouped['pct_change'].apply(lambda x: (x <= -0.0985).sum())
        }).reset_index()
        return _sorted_ma_data, _result

    # è®¡ç®—è¶‹åŠ¿æŒ‡æ ‡
    def calculate_trend_indicators(index_symbol='399101.XSHE'):
        """è®¡ç®—è¶‹åŠ¿æŒ‡æ ‡: è¿‡å»3å¤©å†…åªè¦æœ‰ä¸€å¤©å¤„äºé«˜ä½ï¼Œåˆ™è§†ä¸ºé«˜ä½ï¼Œé¿å…è¾¹ç•Œé—®é¢˜ï¼‰"""
        # å‚æ•°è®¾ç½®
        high_lookback = 60  # è¿‘æœŸé«˜ç‚¹è§‚å¯Ÿçª—å£
        high_proximity = 0.95  # æ¥è¿‘é«˜ç‚¹çš„é˜ˆå€¼ï¼ˆ95%ï¼‰
        check_days = 2  # æ£€æŸ¥è¿‡å»1å¤©çš„çŠ¶æ€

        end_date = context.current_dt.replace(hour=14, minute=49)

        # è·å–å†å²æ•°æ®ï¼ˆéœ€è¦åŒ…å«è¶³å¤Ÿå¤©æ•°ï¼Œç”¨äºè®¡ç®—è¿‡å»5å¤©çš„æŒ‡æ ‡ï¼‰
        # ä¸ºäº†è®¡ç®—è¿‡å»5å¤©çš„æŒ‡æ ‡ï¼Œéœ€è¦å¤šè·å–high_lookbackå¤©æ•°æ®ï¼ˆé¿å…è¾¹ç•Œé—®é¢˜ï¼‰
        total_days_needed = high_lookback + 10
        data = get_bars(index_symbol, end_dt=end_date,
                        count=total_days_needed,
                        unit='1d', fields=['date', 'close', 'high', 'avg', 'volume'], include_now=True, df=True)

        data['date'] = pd.to_datetime(data['date'])

        # è®¡ç®—è¿‡å»æ¯å¤©çš„is_highçŠ¶æ€
        _past_is_high_list = []

        # éå†è¿‡å»2å¤©
        for i in range(-check_days, 0):
            # æ•°æ®åˆ‡ç‰‡ï¼Œæ¯æ¬¡60å¤©ï¼Œä¸åŒ…å«æœ€åä¸€å¤©
            valid_data = data.iloc[:i][-high_lookback:]
            current_day_price = valid_data['close'].iloc[-1]

            # è®¡ç®—å½“å¤©çš„æ¥è¿‘é«˜ç‚¹çŠ¶æ€
            day_max_high = valid_data['high'].max()
            day_close_to_high = current_day_price >= (day_max_high * high_proximity)

            # å½“å¤©çš„is_high
            day_is_high = day_close_to_high
            _past_is_high_list.append(day_is_high)

        # å½“å‰å¤©çš„æŒ‡æ ‡ï¼ˆæœ€åä¸€å¤©ï¼‰
        current_data = data[-high_lookback:]
        current_price = current_data['close'].iloc[-1]
        max_high = current_data['high'].max()
        close_to_high = current_price >= (max_high * high_proximity)

        # å°†å½“å‰å¤©åŠ å…¥åˆ—è¡¨ï¼Œ
        _past_is_high_list.append(close_to_high)

        # æ–°çš„is_highåªè¦æœ‰ä¸€å¤©ä¸ºTrueï¼Œåˆ™ä¸ºTrue
        _is_high = any(_past_is_high_list)

        return _is_high, _past_is_high_list

    # ä¸ºæ–¹ä¾¿å›æµ‹ç›´æ¥ç”¨è®°å½•çš„å†å²è·¯æ ‡å¯¹æ¯”
    cur_date_str = str(context.current_dt.date())
    if cur_date_str <= g.history_defense_date_list[-1]:
        if cur_date_str in g.history_defense_date_list:
            g.defense_signal = True
            print("ç»„20é˜²å¾¡: True, å¤„äºå†å²è§¦å‘èŒƒå›´å†…")
        else:
            g.defense_signal = False
            print("è§¦å‘é˜²å¾¡: False, æœªå¤„äºå†å²è§¦å‘èŒƒå›´å†…")
    # è¶…è¿‡æ—¶é—´åˆ™æ‰‹åŠ¨è®¡ç®—, ç”¨äºå®ç›˜
    else:
        if g.defense_signal:
            # å¦‚æœå·²ç»è¿›å…¥é˜²å¾¡æ¿å—ï¼Œåªè¦çœ‹ç»„20æœ‰æ²¡æœ‰åœ¨å‰ä¸‰
            sorted_ma_data, result = get_market_breadth(20)
            up_ratio = result.iloc[-3:]['up_ratio'].mean()  # æ¶¨è·Œæ¯”
            avg_score = sorted_ma_data['ç»„1']  # å®½åº¦
            # é€€å‡ºç‰ˆæœ¬1ï¼š
            defense_in_top = any([ind in sorted_ma_data.index[:3] for ind in g.industries])  # é€»è¾‘é˜²å¾¡æ¿å—åœ¨å‰3
            bank_exit_signal = not defense_in_top
            # é€€å‡ºç‰ˆæœ¬2ï¼šå®½åº¦å’Œæ¶¨è·Œæ¯”ä¿®å¤
            # bank_exit_signal= up_ratio>=0.5 and avg_score >=55
            g.defense_signal = not bank_exit_signal
            print(f"ç»„20é˜²å¾¡: {g.defense_signal} "
                  f"ç»„1å®½åº¦:{avg_score:.1f} "
                  f"æ¶¨è·Œæ¯”:{up_ratio:.2f} "
                  f"ç»„20é˜²å¾¡æ¬¡æ•°:{sum(g.cnt_bank_signal)} "
                  f"topå®½åº¦:{sorted_ma_data.index[:5].tolist()}")
        else:
            # åˆ¤æ–­æ¡ä»¶
            is_high, past_is_high_list = calculate_trend_indicators()
            if is_high:  # é«˜ä½æˆ–è€…ç¼©é‡
                # è¡Œä¸šå¼ºåº¦åˆ¤æ–­
                sorted_ma_data, result = get_market_breadth(20)
                defense_in_top = any([ind in sorted_ma_data.index[:2] for ind in g.industries])  # é˜²å¾¡æ¿å—åœ¨å‰äºŒ
                # ç‰ˆæœ¬2æ”¹ä¸ºåˆ¤æ–­å‰”é™¤é˜²å¾¡æ¿å—åçš„å¹³å‡å®½åº¦
                avg_score = sorted_ma_data[[ind not in g.industries for ind in sorted_ma_data.index]].mean()
                above_average = avg_score < 60  # å¹³å‡å®½åº¦ä½äº60
                # ç‰ˆæœ¬ä¸‰ï¼Œæ¶¨è·Œæ¯”å‡å€¼ä½äº50%
                up_ratio = result.iloc[-3:]['up_ratio'].mean()
                above_ratio = up_ratio < 0.5
                # ç»„20æ‹©æ—¶ç»¼åˆåˆ¤æ–­
                is_bank_defense = defense_in_top and above_average and above_ratio
                g.defense_signal = is_bank_defense
                if is_bank_defense:
                    g.cnt_bank_signal.append(is_bank_defense)
                print(f"ç»„20é˜²å¾¡: {is_bank_defense} "
                      f"é«˜ä½:{is_high}{past_is_high_list} "
                      f"ç»„1å®½åº¦:{avg_score:.1f} "
                      f"æ¶¨è·Œæ¯”:{up_ratio:.2f} "
                      f"topå®½åº¦:{sorted_ma_data.index[:5].tolist()} ")
            else:
                g.defense_signal = False
                print(f"è§¦å‘é˜²å¾¡: {g.defense_signal} é«˜ä½:{is_high}{past_is_high_list}")

    # æ£€æµ‹åˆ°éœ€è¦é˜²å¾¡è¿›è¡Œç©ºä»“, åªç©ºä»“å°å¸‚å€¼çš„ç¥¨
    now_time = context.current_dt
    if g.defense_signal:
        for stock in g.strategy_holdings[1][:]:
            current_data = get_price(stock, end_date=now_time, frequency='1m', fields=['close', 'high_limit'],
                                     skip_paused=False, fq='pre', count=1, panel=False, fill_paused=True)
            # å·²æ¶¨åœä¸æ¸…ä»“
            if current_data.iloc[0, 0] < current_data.iloc[0, 1]:
                close_position(stock)


# èµ„é‡‘å†å¹³è¡¡, 2000ETFåå¼¹ç­–ç•¥çš„å‘¨æœŸæ— æ³•æ—©äº2023.10, åŸºäºæ­¤æ—¶é—´è¿›è¡Œèµ„é‡‘å¹³è¡¡
def capital_balance_2(context):
    """
    2023.10 ä¹‹å‰ ETFåå¼¹ çš„ä»“ä½çº³å…¥åˆ° ETFè½®åŠ¨ ä¸­
    """
    cur_date = str(context.current_dt.date())
    # åŸºäºé¦–æ¬¡è¿›è¡Œæ£€æµ‹
    if cur_date < "2023-09-28" and g.strategy_ETF_2000_proportion_reset is None:
        g.portfolio_value_proportion[2] += g.strategy_ETF_2000_proportion
        g.portfolio_value_proportion[1] = 0
        g.strategy_ETF_2000_proportion_reset = False
    # åˆ°è¾¾æ—¢å®šæ—¶é—´åè¿›è¡Œæ‹¨æ­£åŸå§‹æ¯”ä¾‹
    elif cur_date >= "2023-09-28" and g.strategy_ETF_2000_proportion_reset is False:
        # è®¡ç®—ETFè½®åŠ¨æ‰€éœ€è¦åˆ†é…èµ„é‡‘
        strategy_total_value = context.portfolio.total_value * g.strategy_ETF_2000_proportion
        # æ£€æµ‹ETFè½®åŠ¨æ˜¯å¦æœ‰æŒä»“, å¦‚æœæœ‰çš„è¯å°±è¦åå‡ºæ¥è¿˜ç»™ETFåå¼¹
        if g.strategy_holdings[2]:
            cur_etf = g.strategy_holdings[2]
            if context.portfolio.positions[cur_etf].closeable_amount > 0:
                o = order_value(context, cur_etf, -strategy_total_value)  # å–å‡ºéœ€è¦é¢„ç•™ç»™ETFè½®åŠ¨çš„èµ„é‡‘
                if o:
                    stock_show = f"{format_stock_code(cur_etf)}: ".ljust(20)
                    print(f"ğŸš›ğŸš›ğŸš›ğŸš›ğŸš› ETFåå¼¹é¢„ç•™èµ„é‡‘è½¬ç§» {stock_show}  "
                          f"å–ä»·{o.price:<7.2f}  "
                          f"æˆæœ¬{o.avg_cost:<7.2f}   "
                          f"å–é‡{o.amount:<7}   "
                          f"ç›ˆäº{(o.price - o.avg_cost) * o.amount:.2f}"
                          f"( {(o.price - o.avg_cost) / o.avg_cost * 100:.2f}% )")
        g.portfolio_value_proportion[2] -= g.strategy_ETF_2000_proportion
        g.portfolio_value_proportion[1] = g.strategy_ETF_2000_proportion
        g.strategy_ETF_2000_proportion_reset = True  # æ‹¨æ­£åŸå§‹æ¯”ä¾‹


#  æ ¹æ®å¸‚å€¼æ’åº
def short_by_market_cap(context, stock_list):
    short_q = query(
        valuation.code,
        valuation.market_cap,  # æ€»å¸‚å€¼ circulating_market_cap/market_cap
    ).filter(
        valuation.code.in_(stock_list),
        valuation.day == context.previous_date,
    ).order_by(valuation.market_cap.asc())
    short_df = get_fundamentals(short_q)
    short_list = short_df['code'].unique().tolist()
    return short_list


""" ====================== æ‰§è¡Œå…¥å£, å®šæ—¶ä»»åŠ¡ä¸‹å‘ ====================== """


def after_code_changed(context):
    unschedule_all()

    # ç­–ç•¥1 å°å¸‚å€¼ç­–ç•¥
    if g.portfolio_value_proportion[0] > 0:
        run_daily(prepare_xsz, '9:05')
        # åˆæ¬¡æ£€æµ‹æˆäº¤é¢
        if g.check_defense and g.defense_signal is None:
            check_defense_trigger(context)
        # æ¯æ—¥å¼€ç›˜å‰æ£€æµ‹å¤§ç›˜é¡¶èƒŒç¦», åªé’ˆå¯¹ç­–ç•¥1
        if g.DBL_control:
            run_daily(check_dbl, '9:31')  # ä¸è¦æ—©äº9ç‚¹30, å¦åˆ™ä¼šå¯¼è‡´ç»˜åˆ¶çš„æ”¶ç›Šæ›²çº¿æ— æ³•æ‹¿åˆ°ä»·æ ¼ä¿¡æ¯
        run_weekly(strategy_1_sell, 2, '09:40')
        run_weekly(strategy_1_buy, 2, '09:40:02')
        run_daily(xsz_sell_stocks, time='10:00')  # æ­¢æŸå‡½æ•°
        # æ¢æ‰‹æ£€æŸ¥
        if g.huanshou_check:
            run_daily(xsz_huanshou_check, '10:30')
        # æ¶¨åœæ¿æ£€æŸ¥
        run_daily(xsz_check_limit_up, '14:00')
        # æˆäº¤é¢å®½åº¦æ£€æµ‹
        if g.check_defense:
            run_daily(check_defense_trigger, '14:50')
        # æ£€æµ‹æ¸…ä»“å¹¶ä¹°å…¥ETF
        run_daily(close_account, '14:50')

    # ç­–ç•¥2 ETFåå¼¹ç­–ç•¥
    if g.strategy_ETF_2000_proportion > 0:
        run_daily(capital_balance_2, '14:45')  # åŸºäº 2023.9.28 è¿›è¡Œèµ„é‡‘å†å¹³è¡¡
        run_daily(strategy_2_sell, '14:49')
        run_daily(strategy_2_buy, '14:50')

    # ç­–ç•¥3 ETFè½®åŠ¨ç­–ç•¥
    if g.portfolio_value_proportion[2] > 0:
        run_daily(strategy_3_sell, '10:35:00')
        run_daily(strategy_3_buy, '10:35:05')
        if g.enable_stop_loss_by_cur_day:
            run_daily(etf_stop_loss_by_cur_day, '10:01')  # æ—¥å†…äºæŸæ£€æµ‹
            run_daily(etf_stop_loss_by_cur_day, '10:31')  # æ—¥å†…äºæŸæ£€æµ‹

    # ç­–ç•¥4 ç™½é©¬ç­–ç•¥
    if g.portfolio_value_proportion[3] > 0:
        run_monthly(bm_before_market_open, 1, time='8:00')
        # run_daily(bm_before_market_open, time='15:10')
        run_monthly(bm_adjust_position, 1, time='10:40')

    # è®°å½•å„ç­–ç•¥æ¯æ—¥æ”¶ç›Š
    run_daily(make_record, '15:01')
    # æ‰“å°æ¯æ—¥æ”¶ç›Š
    run_daily(print_summary, '15:02')
